# Epic 3 Retrospective: Mobile Data Collection & Ingestion Pipeline

**Date:** 2026-02-14
**Facilitator:** Bob (Scrum Master)
**Scope:** Prep Phase (8 stories) + Epic 3 (8 stories) = 16 stories
**Participants:** Full BMAD Team + Awwal (Project Lead)

---

## Executive Summary

Epic 3 delivered the complete mobile data collection and ingestion pipeline — from Google OAuth registration through native form rendering, offline-first PWA, submission sync, idempotent ingestion, and NIN uniqueness enforcement. The epic was preceded by a highly effective prep phase that resolved all technical debt and preparation tasks from the Epic 2+2.5 retrospective.

**Key Achievement:** 16 stories completed in 4 calendar days (1 day prep + 3 days epic) with zero regressions across 1,602 tests. Previous retro follow-through improved from 40% to 93%.

---

## Team Participants

| Name | Role |
|------|------|
| Awwal | Project Lead |
| Alice | Product Owner |
| Bob | Scrum Master (Facilitator) |
| Charlie | Senior Developer |
| Dana | QA Engineer |
| Elena | Junior Developer |
| Winston | Architect |

---

## Combined Metrics

| Metric | Prep Phase | Epic 3 | Combined |
|--------|-----------|--------|----------|
| Stories | 8 | 8 | **16** |
| Completion | 8/8 (100%) | 8/8 (100%) | **16/16 (100%)** |
| Calendar Days | 1 (Feb 11) | 3 (Feb 12-14) | **4 days** |
| Code Review Findings | ~66 | ~83 | **~149 total** |
| Critical Findings | 0 | 15 | **15** |
| Stories Requiring R2 | 0 | 1 (Story 3.6) | **1** |
| Test Growth | +14 | +305 | **+319 tests** |
| Final Test Baselines | — | 362 API + 1,240 web | **1,602 total** |
| Regressions | 0 | 0 | **0** |
| Production Incidents | 0 | 0 | **0** |

### Code Review Findings by Story

| Story | Critical | High | Medium | Low | Total |
|-------|----------|------|--------|-----|-------|
| prep-1 ODK Cleanup | 0 | 0 | 2 | 3 | 5 |
| prep-2 Shared Role Constants | 0 | 1 | 3 | 4 | 8 |
| prep-3 DB Migration Fix | 0 | 1 | 4 | 3 | 8 |
| prep-4 Playwright Setup | 0 | 0 | 5 | 3 | 8 |
| prep-5 SW/IndexedDB Spike | 0 | 0 | 5 | 4 | 9 |
| prep-6 Load Test Baseline | 0 | 2 | 5 | 1 | 8 |
| prep-7 E2E Golden Path | 0 | 1 | 5 | 3 | 9 |
| prep-8 Story 3.1 ACs | 0 | 2 | 3 | 2 | 7 |
| 3-0 Google OAuth | 2 | 3 | 2 | 1 | 8 |
| 3-1 Native Form Renderer | 3 | 4 | 3 | 0 | 10 |
| 3-2 PWA/Offline Assets | 0 | 2 | 4 | 2 | 8 |
| 3-3 Offline Queue & Sync | 3 | 5 | 4 | 1 | 13 |
| 3-4 Submission Ingestion | 2 | 3 | 4 | 3 | 12 |
| 3-5 Public Self-Registration | 0 | 0 | 3 | 2 | 5 |
| 3-6 Clerk Data Entry | 2 | 6 | 7 | 3 | 18 |
| 3-7 NIN Uniqueness | 3 | 4 | 4 | 2 | 13 |
| **TOTAL** | **15** | **34** | **63** | **37** | **149** |

All 149 findings resolved (148 fixed, 1 accepted).

### Test Count Progression

| After Story | Web Tests | API Tests | Total |
|-------------|-----------|-----------|-------|
| Epic 2.5 end (baseline) | 957 | 326 | 1,283 |
| prep-5 | 971 | 268 | 1,239 |
| 3-0 Google OAuth | 971 | 280 | 1,251 |
| 3-1 Native Form Renderer | ~1,070 | 287 | ~1,357 |
| 3-2 PWA/Offline | 1,096 | 290 | 1,386 |
| 3-3 Offline Queue | 1,143 | 297 | 1,440 |
| 3-4 Submission Ingestion | 1,164 | 337 | 1,501 |
| 3-5 Public Registration | 1,178 | 337 | 1,515 |
| 3-6 Clerk Data Entry | 1,210 | 346 | 1,556 |
| 3-7 NIN Uniqueness | 1,240 | 362 | 1,602 |

---

## Previous Retrospective Follow-Through

**Source:** Epic 2+2.5 Combined Retrospective (2026-02-10)
**Previous follow-through rate:** 40% → **This epic: 93% (13/14)**

### Process Actions

| Item | Description | Status | Evidence |
|------|------------|--------|----------|
| P1 | Spike-first for external integrations | ✅ Completed | prep-5 (SW/IndexedDB spike) before Stories 3.2/3.3 |
| P2 | Story sizing guardrails (15 tasks max) | ✅ Applied | No story exceeded 15 tasks |
| P3 | Structured UAT after each story | ✅ Completed | Awwal verified frontend stories on dev server; backend stories verified via test suites |
| P4 | Spec compliance check at mid-epic | ✅ Completed | Awwal performed mid-epic alignment check |

### Technical Debt

| Item | Description | Status | Evidence |
|------|------------|--------|----------|
| T1 | ODK cleanup (Story 2.5-2) | ✅ Completed | prep-1 |
| T2 | DB migration workflow fix | ✅ Completed | prep-3 |
| T3 | Shared role constants | ✅ Completed | prep-2 |
| T4 | Test selector convention (A3) | ⏳ Ongoing | Violations still caught in Stories 3.2, 3.3, 3.6 |
| T5 | fileBlob base64 → bytea | ❌ Not addressed | LOW priority — carried to Epic 4 prep |
| T6 | Sub-path exports | ❌ Not addressed | LOW priority — carried to Epic 4 prep |

### Epic 3 Preparation Tasks

| Item | Description | Status |
|------|------------|--------|
| EP1 | ODK cleanup standalone task | ✅ prep-1 |
| EP2 | Update Story 3.1 ACs (admin preview) | ✅ prep-8 |
| EP3 | Playwright framework setup | ✅ prep-4 |
| EP4 | Service Worker/IndexedDB spike | ✅ prep-5 |
| EP5 | DB migration workflow guide | ✅ prep-3 |
| EP6 | k6 load test baseline | ✅ prep-6 |
| EP7 | E2E golden path spec | ✅ prep-7 |

### Team Agreements (A1-A6)

| # | Agreement | Status |
|---|-----------|--------|
| A1 | Cancel buttons in dialogs | ✅ Maintained |
| A2 | Skeleton shape matching | ✅ Applied consistently |
| A3 | Test selectors (text/data-testid/ARIA only) | ⏳ Still violated — needs enforcement |
| A4 | 15-task split rule | ✅ No oversized stories |
| A5 | Spike-first for external integrations | ✅ Applied (prep-5) |
| A6 | UAT after every story | ✅ Maintained |

---

## Successes

### 1. Prep Phase Model Validated
All 8 preparation tasks completed in a single day. This eliminated debt and uncertainty before the epic started, enabling clean execution. The spike-first approach (prep-5) was particularly impactful — every offline architecture decision held through Stories 3.2, 3.3, and 3.4 with zero rework.

### 2. Extraordinary Velocity
16 stories in 4 calendar days. The pattern-investment from early stories (3.0, 3.1) enabled rapid execution of later stories (3.5 had only 5 review findings because it rode established patterns).

### 3. Adversarial Code Review Catches Real Bugs
149 findings across 16 stories, including 15 Critical. Notable catches:
- Unreachable auth code path in `loginPublic()` (Story 3.0 CR-1)
- Security hole: draft forms exposed via render endpoint (Story 3.1 C2)
- Anti-enumeration leak in password reset (Story 3.0 CR-5)
- Entire features marked done but not implemented (Stories 3.3, 3.7)
- GPS data never reaching submission columns (Story 3.4 C2)

### 4. Zero Regressions
1,602 tests at completion, zero regressions across all 16 stories. Test growth of +319 tests demonstrates consistent coverage investment.

### 5. Architecture Decisions Held
Key architectural choices proved sound:
- StaleWhileRevalidate over NetworkFirst for field networks (Story 3.2)
- SyncManager as vanilla singleton class, not React hook (Story 3.3)
- Three-layer NIN defense: pre-check, ingestion rejection, status polling (Story 3.7)
- Separate ClerkDataEntryPage vs FormFillerPage mode (Story 3.6)

---

## Challenges

### 1. "Tasks Marked Done But Not Implemented" (5 occurrences)
The most significant process issue. In Stories 3.3, 3.4, and 3.7, tasks were checked off in the story file without the corresponding code being written. Examples:
- Story 3.3: `retryFailed()` method missing, `completeDraft()` payload not enriched, sync status states incomplete
- Story 3.7: FormFillerPage and ClerkDataEntryPage NIN pre-check tests not written

All caught by adversarial code review, but this pattern erodes trust in the story file as source of truth.

### 2. Test Selector Violations Persist (A3)
CSS class selectors and non-compliant test selectors appeared in Stories 3.2, 3.3, and 3.6 despite Team Agreement A3. The pattern keeps recurring because the dev agent defaults to common React testing patterns. Needs automated enforcement, not just review-and-fix.

### 3. Story 3.6 Required Two Code Review Rounds
The clerk data entry page was the most complex story (18 total findings). Round 1 discovered 30/52 tests failing due to missing `afterEach(cleanup)` — a DOM leakage issue that had silently accumulated across 95 test files in the entire codebase.

### 4. NIN Behavior Changed Mid-Epic
Story 3.4 implemented NIN duplicate linking per PRD FR21. Story 3.7 changed it to rejection. This was a product decision made during implementation without updating the PRD. **Resolution:** Awwal confirmed rejection is the correct behavior. PRD to be updated in prep phase.

### 5. File List Documentation Gaps
Nearly every story had findings about missing files in the documented File List (especially `pnpm-lock.yaml`, `sprint-status.yaml`, `package.json` files). Low severity but the most common finding type.

---

## Recurring Code Review Themes

| Pattern | Occurrences | Stories | Severity |
|---------|-------------|---------|----------|
| Tasks marked done but not implemented | 5 | 3.3, 3.4, 3.7 | Critical |
| File List documentation gaps | ~10 | Nearly all | Low |
| Test selector violations (A3) | 3+ | 3.2, 3.3, 3.6 | Medium |
| Source/enum mismatches | 2 | 3.4, 3.5 | Critical/Medium |
| GPS data handling bugs | 2 | 3.3, 3.4 | Critical |
| Dev Agent Record incomplete | 2 | 3.1, 3.4 | High |

---

## Breakthrough Moments

1. **prep-3 (DB Migration Fix):** Deep reverse-engineering of drizzle-kit's hanji TUI library to create an auto-approval wrapper — avoided a risky major version upgrade.
2. **prep-5 → Stories 3.2/3.3:** Spike decisions (Dexie, SWR, injectManifest) carried perfectly through implementation with zero rework.
3. **Story 3.2:** Deliberate StaleWhileRevalidate deviation from spike recommendation, optimizing for slow/flaky Oyo State field networks.
4. **Story 3.4 Task 0:** Proactively added Modulus 11 NIN validation to the form renderer before the ingestion pipeline existed — closing a data quality gap at the source.
5. **Story 3.7:** Three-layer NIN defense architecture with graceful offline degradation.

---

## Bugs Discovered During Retrospective

### Bug 1: Forms Permanently Marked "Completed"
**Discovered by:** Awwal (UAT)
**Description:** After submitting a survey, the form card on Enumerator/Clerk/Public surveys pages shows "Completed" permanently. Users cannot start a new submission for the same form. This is incorrect — enumerators and clerks need to submit the same form dozens of times for different respondents.
**Root Cause:** Draft status check in surveys pages assumes one draft per form. Completed drafts block new ones.
**Impact:** Blocks real-world field use — enumerators can only submit one survey per form.
**Resolution:** Prep task prep-1 for Epic 4.

### Bug 2: Missing Dashboard Submission Counters
**Discovered by:** Awwal (UAT)
**Description:** Enumerator and Clerk dashboards show sync status (synced/pending/failed) but no persistent "Surveys completed: N" counter. Users cannot see how many forms they've filled.
**Impact:** Field workers lack visibility into their own productivity.
**Resolution:** Prep task prep-2 for Epic 4.

---

## FR21 Product Decision

**Issue:** PRD FR21 specifies NIN duplicate **linking** (accept submission, link to existing respondent). Story 3.7 implements NIN duplicate **rejection** (reject submission with error message).

**Decision (Awwal, 2026-02-14):** Keep rejection behavior. Rationale: prevents wasted field time on already-registered individuals. PRD to be updated.

**Resolution:** Prep task prep-3 for Epic 4 — update PRD FR21 to match rejection implementation.

---

## Epic 4 Preview: Supervisor Oversight & Field Management

### Stories Planned
- 4-1: Supervisor Team Dashboard (real-time team progress, GPS map)
- 4-2: In-App Team Messaging (real-time, audit trail)
- 4-3: Fraud Engine Configurable Thresholds (admin UI)
- 4-4: Flagged Submission Review (evidence panel, verify/reject)
- 4-5: Bulk Verification of Mass Events
- TD-4.1: React Hook Form + Zod Migration (tech debt)

### Dependencies on Epic 3
- Submission pipeline (Story 3.4) — respondent records, GPS data, fraud detection queue stub
- NIN uniqueness enforcement (Story 3.7) — rejected submissions visible to supervisors
- Sync infrastructure (Story 3.3) — reliable data flow from field to server

### New Domains Requiring Spikes
- Real-time messaging (WebSocket/SSE) for Story 4.2
- Fraud detection heuristics (GPS clustering, speed-run detection) for Story 4.3
- Supervisor-enumerator team assignment schema for Story 4.1

---

## Action Items

### Process Improvements

| # | Action | Owner | Success Criteria |
|---|--------|-------|-----------------|
| P1 | Add dev agent guardrail: verify task code exists before marking done | Bob (SM) | Added to project-context.md or story template |
| P2 | Enforce A3 test selectors via ESLint rule | Charlie (Dev) | ESLint plugin blocks CSS class selectors in test files |
| P3 | Continue adversarial code review on every story | Team | No exceptions |
| P4 | Continue spike-first for new domains | Bob (SM) | Spikes before Epic 4 stories |

### Team Agreements (carried forward + new)

| # | Agreement | Status |
|---|-----------|--------|
| A1 | Every AlertDialog must include Cancel button | Carried |
| A2 | Skeleton loading layouts match content shape | Carried |
| A3 | Tests use text/data-testid/ARIA — never CSS classes | Carried + ESLint enforcement |
| A4 | Stories exceeding 15 tasks get split | Carried |
| A5 | External integrations start with spike | Carried |
| A6 | UAT after every story | Carried |
| A7 | Dev agent must verify task implementation before marking complete | **New** |
| A8 | Stories with 10+ subtasks get mid-implementation self-review checkpoint | **New** |

---

## Prep Phase: Epic 4 Readiness

| # | Task | Description | Priority |
|---|------|-------------|----------|
| prep-1 | Fix "permanently completed" form bug | Allow new submissions for same form after previous ones complete. Fix Enumerator, Public, Clerk surveys pages. | CRITICAL |
| prep-2 | Dashboard submission counters | Add persistent "Surveys completed: N" to Enumerator, Clerk, Public dashboards | HIGH |
| prep-3 | FR21 PRD alignment | Update PRD FR21: change NIN duplicate behavior from "link" to "reject" | HIGH |
| prep-4 | TD-4.1: React Hook Form + Zod migration | Migrate FormFillerPage and ClerkDataEntryPage to RHF+Zod per ADR-4.3 | MEDIUM |
| prep-5 | A3 ESLint enforcement | Add ESLint rule blocking CSS class selectors in test files | MEDIUM |
| prep-6 | Real-time messaging spike | WebSocket/SSE research for Story 4.2 — validate approach, choose library, create PoC | HIGH |
| prep-7 | Fraud detection domain research | GPS clustering, speed-run detection heuristics for Story 4.3. Define threshold schema. | HIGH |
| prep-8 | Supervisor team assignment schema | Verify/create DB schema for supervisor → enumerator team relationships (Story 4.1) | HIGH |
| prep-9 | fileBlob base64 → bytea | Carried from T5 (Epic 2+2.5 retro) — resolve or drop | LOW |
| prep-10 | Sub-path exports for @oslsr/types | Carried from T6 (Epic 2+2.5 retro) — resolve or drop | LOW |

---

## Key Takeaways

1. **Prep phase model is proven.** 8 tasks in 1 day → clean epic execution. Repeat for Epic 4.
2. **Spike-first prevents rework.** prep-5 decisions held perfectly through 3 stories.
3. **Adversarial code review is non-negotiable.** 15 Critical bugs caught — including security holes and unimplemented features.
4. **"Tasks marked done but not implemented" is the #1 process risk.** Needs guardrail (Agreement A7).
5. **Pattern investment enables velocity.** Early complex stories (3.0, 3.1) set patterns that later stories (3.5) rode to 5-finding reviews.
6. **Test cleanup debt accumulates silently.** The 95-file cleanup in Story 3.6 was overdue.
7. **UAT catches what tests can't.** Awwal's UAT discovered the "permanently completed" form bug that 1,602 tests missed.

---

## Next Steps

1. **Execute Prep Phase** (10 preparation tasks)
2. **Update `epic-3` status to `done`** in sprint-status.yaml
3. **Push to remote and deploy to staging** for Awwal's verification
4. **Begin Epic 4** with structured UAT after each story
5. **Story 4.1 UAT milestone** — Awwal views supervisor dashboard with real submission data

---

**Retrospective Approved By:**
- Alice (PO) — Product scope validated, FR21 decision documented
- Winston (Architect) — Technical decisions sound, prep spikes appropriate
- Charlie (Dev) — Implementation ready, debt plan clear
- Dana (QA) — Quality strategy maintained, A3 enforcement planned
- Elena (Dev) — Research spikes scoped
- Bob (SM) — Process improvements captured, agreements updated
- Awwal (Project Lead) — Bugs surfaced, FR21 decision made, prep phase approved

**Next:** Execute prep phase, then begin Epic 4 Story 4.1 (Supervisor Team Dashboard)

---

*Generated: 2026-02-14*
*Facilitator: Bob (Scrum Master)*
*Retrospective Workflow: bmad:bmm:workflows:retrospective*
