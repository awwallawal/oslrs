# Epic 5 Retrospective: Back-Office Audit & Policy Reporting

**Date:** 2026-02-24
**Facilitator:** Bob (Scrum Master)
**Participants:** Alice (Product Owner), Charlie (Senior Dev), Dana (QA Engineer), Elena (Junior Dev), Awwal (Project Lead)
**Scope:** Prep-Epic-5 (8 stories) + Epic 5 (7 stories) = 15 stories total

---

## Epic Summary

**Epic 5 Goal:** Provide high-level stakeholders and state auditors with the tools to verify registry integrity and extract policy-driving insights.

**FRs Covered:** FR15 (Back-Office Reporting), FR16 (Audit Trails — foundation via AuditService)

### Delivery Metrics

| Metric | Prep Phase | Epic 5 | Combined |
|--------|-----------|--------|----------|
| Stories | 8/8 (100%) | 7/7 (100%) | 15 total |
| Code review findings | 73 | 69 | 142 |
| Fix rate | ~97% | ~97% | ~97% (4 LOW deferred/accepted) |
| New tests | ~200+ | ~460+ | ~660+ (+30%) |

**Test Baseline:** 667 API + 1,512 web = 2,179 (start of Epic 5)
**Final:** ~1,795 web + ~900 API = ~2,700+ tests

### Previous Retro Follow-Through: Mixed (1/5 complete, 2/5 partial, 1/5 not addressed, 1/5 unclear)

| # | Action Item (from Epic 4 Retro) | Status |
|---|--------------------------------|--------|
| 1 | Story sizing discipline — target 12, hard limit 15 | ✅ Completed — all stories ≤ 12 tasks |
| 2 | WHERE clause test verification standard | ⏳ Partial — standard exists but 4/7 stories still flagged for missing 403 tests |
| 3 | File List accuracy enforcement | ⏳ Partial — improved, but 5-6b had empty Dev Agent Record (Critical) |
| 4 | Extract CI/CD pipeline as reusable template | ❌ Not Addressed — cross-project, deferred |
| 5 | Update project-context.md with Epic 4 patterns | ⏳ Unclear — stories reference patterns but formal update unconfirmed |

**Epic 5 Prep Task Follow-Through: 8/8 = 100%**

**Pattern confirmed:** Story-shaped work completes at 100%. Open-ended process commitments slip.

### Deferred Review Items (from Epic 4 — all LOW)

All 5 carried forward. None caused issues in Epic 5.

---

## Key Capabilities Delivered

### Prep Phase
- **prep-1:** Fixed supervisor direct messaging UX gap — added "New Conversation" flow with team roster picker. 51 messaging tests.
- **prep-2:** Lightweight AuditService with fire-and-forget + transactional modes. Used by Stories 5-3, 5-4, 5-5, 5-6a, 5-6b (5 stories). 12 tests.
- **prep-3:** Export infrastructure spike — ExportService with PDF + CSV generation, security controls (role auth, audit logging, rate limiting 5/hr/user). Performance benchmarked. Used by Stories 5-4, 5-6a. 19 tests.
- **prep-4:** Defined Story 5.5 (Respondent Data Registry Table) + split Story 5.6 into 5.6a/5.6b per A4 task limit.
- **prep-5:** Cross-LGA query performance validation — all 13 queries validated at 500K scale, 4 indexes recommended. Proved feasibility before implementation.
- **prep-6:** Assessor workflow state machine design — submission lifecycle with 8 derived verification statuses. Used by Stories 5-2, 5-3, 5-5.
- **prep-7:** E2E test expansion — 14 Playwright tests for fraud thresholds, messaging, supervisor dashboard. Layer 3 coverage.
- **prep-8:** Role-based activation wizard — back-office 1-step password-only, field staff 5-step. 62 tests.

### Epic 5 Stories
- **5-1:** High-level policy dashboard — Government Official state-wide labor statistics, skills charts, LGA heatmaps. Direction 08 styling. 79 tests.
- **5-2:** Verification assessor audit queue — state-wide queue for secondary QC of supervisor-verified/high-fraud submissions. Accordion evidence panel with optional review actions. 78 tests.
- **5-3:** Individual record PII view — authorized deep-dive with mandatory audit logging. Multi-JOIN query pattern, PII stripping server-side for supervisor role. 45 tests.
- **5-4:** PII-rich CSV/PDF exports — filtered dataset exports with rate limiting (5/hr), DISTINCT ON deduplication for multi-submission respondents. PDF max 1K rows enforced. 49 tests.
- **5-5:** Respondent data registry table — server-paginated (cursor-based), 9 filter controls, role-based column visibility, 5 quick-filter presets, live monitoring with 60s auto-refresh. TanStack Table v8 in server-side mode. Born from Epic 4 retro. 74 tests.
- **5-6a:** Supervisor team productivity table — two new DB tables (daily_productivity_snapshots, productivity_targets), WAT timezone boundaries, BullMQ nightly snapshot job, Redis caching with 5-min TTL. 75 tests.
- **5-6b:** Super Admin cross-LGA analytics + Government Official view — 15-column staff performance, LGA comparison with supervisorless LGA detection, Government Official aggregate-only view. Dynamic productivity targets fix across 3 dashboard pages. 48+ tests.

---

## Successes

### 1. Spike-First Pattern (A5) — Third Consecutive Epic of Zero Rework
- prep-3 (Export Spike) → exact ExportService architecture used in Story 5-4
- prep-6 (State Machine Design) → verification status framework used in 5-2, 5-3, 5-5
- prep-5 (Performance Validation) → all 13 queries proven at 500K scale before implementation
- Spike-first is the team's most valuable and validated process innovation.

### 2. Prep Tasks as Force Multipliers
AuditService (prep-2) used by 5 stories. ExportService (prep-3) used by 2 stories. State machine design (prep-6) informed 3 stories. 8/8 prep tasks completed, each feeding directly into epic success. The prep phase investment paid compounding returns.

### 3. Story Sizing Discipline Held
All stories stayed at or under 12 tasks — the target set in the Epic 4 retro. The 5.6a/5.6b split (from original 5.6) prevented scope creep. No story hit the 15-task hard ceiling. A4 discipline is now reflexive.

### 4. Retrospective-to-Value Pipeline
Story 5.5 (Respondent Data Registry Table) was discovered during the Epic 4 retrospective, fully defined in prep-4, and delivered as a production feature. Demonstrates the retrospective process directly creating product value.

### 5. Patterns Strong Enough to Export
The process patterns (spike-first, adversarial review, prep-as-force-multipliers, three-layer quality model) are being exported to a second project. The ultimate validation of process maturity.

### 6. Adversarial Code Review Maturity
142 findings across 15 stories with ~97% fix rate. Zero regressions. The review process caught Critical issues (missing service tests in 5-5, empty Dev Agent Record in 5-6b) that would have degraded quality.

---

## Challenges

### 1. 403 Authorization Test Gaps — Still Recurring
The #1 recurring issue for the second consecutive retro. Found in 4 of 7 epic stories (5-1, 5-4, 5-5, 5-6b). Tests verify authorized roles get data but don't check unauthorized roles get 403. The standard was added to project-context.md per Epic 4 retro, but it's not reflexive yet — dev agents need review to remind them.

### 2. Tasks Marked Done Without Tests
Story 5-5 had a CRITICAL finding: Task 10 marked `[x]` with zero service tests. 5-6b also flagged for below-minimum service tests. Pattern: implementation tasks marked complete before writing corresponding tests.

### 3. Dev Agent Record / File List Accuracy
5-6b submitted with completely empty Dev Agent Record (Critical finding). prep-4 had undocumented scope expansion. Improved from Epic 4 (6/14 → fewer) but still occurring. Documentation discipline remains a challenge.

### 4. Stale/Hardcoded Values Pattern
Story 5-5: QuickFilterPresets computed dates at module-load, not click time — stale after midnight. Story 5-6b: Three dashboard pages had hardcoded DAILY_TARGETS constants while backend has configurable targets. Subtle bugs that tests don't naturally catch.

### 5. Late Production UAT
Authenticated flows on the live website weren't tested until late in Epic 5. Three UI bugs discovered in minutes of manual exploration (export race condition, padding inconsistency, fraud thresholds sidebar issue). Strong Layers 1-2 but Layer 3 only happened because Awwal happened to try it.

### 6. Process Action Items Partially Completed
Only 1 of 5 Epic 4 process action items fully completed. The pattern: prep tasks (story-shaped) complete at 100%, but open-ended process commitments slip. This is a structural insight about how to frame future action items.

---

## Bugs Discovered During Retrospective

### Bug B1: Export Page Race Condition
**Discovered by:** Awwal (UAT during retrospective)
**Severity:** MEDIUM
**Description:** `/dashboard/super-admin/export` throws "lgas.map is not a function" on initial load, then loads on retry. Both local and production. Likely missing loading guard or default empty array for async LGA data.
**Action:** prep-1 in Epic 6 prep phase.

### Bug B2: Dashboard Page Padding Inconsistency
**Discovered by:** Awwal (UAT during retrospective)
**Severity:** LOW
**Description:** `/super-admin/questionnaires` and `/super-admin/registry` have content too close to sidebar. Inconsistent with `/super-admin/staff` which has proper `p-6` padding. Same issue was fixed for SupervisorProductivityPage in 5-6b.
**Action:** prep-2 in Epic 6 prep phase.

### Bug B3: Fraud Thresholds Sidebar + Data Issue
**Discovered by:** Awwal (UAT during retrospective)
**Severity:** MEDIUM
**Description:** Clicking "Fraud Thresholds" in sidebar highlights both "Fraud Thresholds" and "Settings" simultaneously (route matching issue). Page shows "No fraud thresholds configured" despite thresholds being implemented in Story 4-3 and E2E tested in prep-7. Likely: seed data not deployed on production, or API endpoint connection issue.
**Action:** prep-3 in Epic 6 prep phase.

---

## Key Insights

1. **The three-layer quality model works — bugs surfacing at Layer 3 is expected, not failure.** Automated tests catch code bugs, adversarial review catches architectural gaps, UAT catches integration and UX issues. The fix cycle is the contract.

2. **Story-shaped work completes at 100%; open-ended process commitments slip.** Frame future action items as concrete, deliverable tasks — not aspirations. This is a structural insight about how to drive change.

3. **UAT needs to happen earlier and consistently, not as late-epic discovery.** A lightweight post-deployment smoke checklist (login as each role, verify key pages) would have caught all three bugs found today.

4. **Recurring issues need structural fixes, not repeated standards.** The 403 test gap was flagged in two consecutive retros. Solution: bake it into the story template as a default task so it's present from the start, not caught in review.

5. **Prep-as-force-multipliers is a compounding advantage.** Each epic's prep phase builds reusable infrastructure. AuditService (prep-2) → 5 stories. ExportService (prep-3) → 2 stories. This pattern should continue.

6. **Project culture accumulates through retrospectives.** Five epics of decisions, patterns, agreements, and lessons create institutional memory that shapes how the team works. This is non-transferable — new projects develop their own culture through their own history.

---

## Super Admin Governance (Discovered During Retro)

**Raised by:** Awwal
**Description:** Currently only one Super Admin exists, created via `db:seed --admin-from-env`. No in-app flow to create additional Super Admins. Three governance requirements identified:

1. **Create additional Super Admins** — Super Admin should be able to invite/provision other Super Admins through the existing staff provisioning + invitation system.
2. **Last-admin protection** — System must prevent deletion/deactivation of the last remaining Super Admin. Database-level count check: if active Super Admin count = 1, reject deletion.
3. **Self-deletion prevention** — A Super Admin cannot delete or deactivate their own account. Compare `req.user.id` against target user ID.

**Technical assessment:** Invitation flow likely already supports Super Admin role. Governance guards are service-level checks, not full features. Captured as prep-10 in Epic 6 prep phase.

---

## Epic 6 Preview: System Integrity, Accountability & Remuneration

**Epic 6 Goal:** Ensure system integrity through immutable audit logging, automated monitoring, and off-site backups. Provide staff remuneration record-keeping and dispute resolution. Add Super Admin View-As capability.

### Critical Scoping Decision (from Retro)

**Remuneration model:** Record-keeping only, NOT payment processing integration.
- Payments happen outside the app via bank's native tools
- OSLRS role: upload PDF receipts as proof of payment, tagged to staff members
- Staff can view payment history and receipts, raise disputes
- Disputes resolved in-app with evidence trail
- Rationale: Avoids the complexity of payment gateway integration while providing full accountability

This decision significantly de-risks Stories 6-4, 6-5, 6-6.

### Dependencies on Epic 5
- `AuditService` (prep-2) → foundation for Story 6-1 (needs durability upgrade)
- `productivity_targets` + `daily_productivity_snapshots` (5-6a) → foundation for Stories 6-4/6-5
- Role-based dashboard routing (all Epic 5) → foundation for Story 6-7
- prep-8 noted back-office roles skip bank details — profile editing flow may be needed for remuneration

---

## Action Items

### Bug Fixes

| # | Action | Owner | Success Criteria |
|---|--------|-------|-----------------|
| B1 | Fix export page `lgas.map` race condition | Charlie (Dev) | Page loads without error locally and on production |
| B2 | Fix dashboard page padding consistency | Elena (Dev) | All dashboard pages have identical padding from sidebar |
| B3 | Fix fraud thresholds sidebar + data issue | Charlie (Dev) | Single sidebar highlight. Thresholds page shows seeded data on production. |

### Process Improvements

| # | Action | Owner | Success Criteria |
|---|--------|-------|-----------------|
| P1 | Create post-deployment production smoke test checklist | Dana (QA) | Written checklist: login per role, verify sidebar, load key pages. Run after every deployment. |
| P2 | Add 403 unauthorized test to story template/boilerplate | Charlie (Dev) | Every new story includes unauthorized role rejection tests as standard task. |
| P3 | Update project-context.md with Epic 5 patterns | Dev agent | AuditService, ExportService, cursor pagination, productivity tables, WAT timezone, TanStack Table server-side mode. |
| P4 | CI/CD pipeline template extraction (carried from Epic 4) | Awwal + Charlie | Packaged as portable template. Validated against second project. |

### Technical Debt

| # | Item | Priority | Owner |
|---|------|----------|-------|
| TD1 | 4 pre-existing test failures in `fraud-detections-bulk.controller.test.ts` | LOW | Charlie (Dev) |
| TD2 | 5 deferred LOW review items from Epic 4 (carried forward) | LOW | Unassigned |
| TD3 | Story 5-5 Task 2.0 — gender JSONB key verification + expression index | MEDIUM | Dev agent |
| TD4 | `sql.raw()` usage in respondent service STATUS_FILTER_MAP | LOW | Accepted |

### Team Agreements

- **A6: Post-deployment smoke test** — After every production deploy, run the P1 checklist before moving to next story.
- **A7: 403 tests are mandatory** — Every controller endpoint must have unauthorized role rejection tests. Missing 403 tests are a code review blocker.
- **A8: Tasks aren't done without tests** — A task marked `[x]` without corresponding tests is a review failure. No exceptions.

---

## Epic 6 Preparation Tasks

### Critical Prep (before epic starts)

| # | Task | Priority | Description |
|---|------|----------|-------------|
| prep-1 | Fix export page `lgas.map` race condition | HIGH | Bug B1. Loading guard or default empty array. |
| prep-2 | Fix dashboard padding consistency | LOW | Bug B2. Visual audit + `p-6` fix across all dashboard pages. |
| prep-3 | Fix fraud thresholds sidebar + data | MEDIUM | Bug B3. Route matching fix + production seed investigation. |
| prep-4 | Immutable audit log architecture spike | HIGH | Write-once table, hash chaining, partitioning, retention. Feeds 6-1. |
| prep-5 | Remuneration domain modeling | HIGH | Payment batch schema, PDF receipt storage, dispute state machine. Based on Awwal's workflow: bank payment → receipt upload → staff view → dispute. |
| prep-6 | View-As authentication context spike | MEDIUM | Role impersonation design, audit trail, permission scoping. Feeds 6-7. |
| prep-10 | Super Admin governance guards | HIGH | Last-admin protection, self-deletion prevention, verify invitation flow for Super Admin role. |

### Parallel Prep (during early stories)

| # | Task | Priority | Description |
|---|------|----------|-------------|
| prep-7 | Monitoring infrastructure spike | MEDIUM | prom-client + dashboard validation. Feeds 6-2. |
| prep-8 | Backup orchestration research | MEDIUM | DigitalOcean snapshots vs. pg_dump to object storage. Feeds 6-3. |
| prep-9 | Fix 4 pre-existing test failures | LOW | `fraud-detections-bulk.controller.test.ts` — clear the red. |

---

## Commitments and Next Steps

1. **Fix production bugs** (B1, B2, B3) immediately
2. **Execute prep tasks** (10 items, 4 HIGH priority)
3. **Complete process improvement action items** (P1-P4)
4. **Begin Epic 6** when critical prep tasks complete
5. **Review action items in next standup** — ensure ownership is clear

---

## Team Performance

Epic 5 delivered 15 stories (8 prep + 7 epic) with 142 code review findings at a ~97% fix rate, ~660 new tests (+30% growth), and zero regressions. The team achieved 100% story completion for both prep and epic phases. The spike-first pattern delivered zero-rework implementations for the third consecutive epic. Prep tasks served as force multipliers — AuditService alone was used by 5 stories.

The retrospective surfaced 6 key insights, 3 production bugs, and a critical governance gap (Super Admin management). The remuneration scoping decision (record-keeping, not payment processing) significantly de-risks Epic 6. The team is well-positioned for Epic 6 success with strong foundations in audit logging, export infrastructure, productivity tracking, and dashboard patterns.

Process maturity continues to improve: the team's patterns are now being exported to a second project, and the retrospective-to-value pipeline (Story 5.5) is validated. The main areas for improvement are: earlier/consistent UAT, structural enforcement of 403 tests, and framing process improvements as story-shaped work to ensure completion.

---

*Generated: 2026-02-24 | Retrospective facilitated by Bob (Scrum Master)*
