# Story 1.5.1: Design System Foundation & Layout Architecture

Status: done

## Story

As a **Developer**,
I want to **implement the core design system tokens and layout components per ADR-016**,
so that all subsequent pages share consistent styling and navigation patterns.

## Acceptance Criteria

1. **AC1: Design Tokens Extended**
   - GIVEN the existing design tokens in `apps/web/src/index.css`
   - WHEN I review the UX Design Specification typography requirements
   - THEN the following MUST be added/verified:
     - Full typography scale (H1-H4, Body Large, Body, Body Small, Caption)
     - Font family variables complete (`--font-brand`, `--font-ui`, `--font-mono`)
     - Spacing scale based on 4px baseline grid (--spacing-1 through --spacing-16)
     - All color tokens present (Primary, Success, Warning, Error, Info, Neutrals)
   - AND fonts loaded via Google Fonts with `font-display: swap` in index.html

2. **AC2: PublicLayout Component**
   - GIVEN a visitor on any public page (/, /about/*, /participate/*, /support/*)
   - WHEN the page renders
   - THEN PublicLayout MUST include:
     - Global header with Oyo State logo (40px height) linking to `/`
     - Primary navigation: About (dropdown), Participate (dropdown), Support, Marketplace
     - Mobile hamburger menu (`md:` breakpoint, < 768px) with slide-in drawer
     - Footer with 3-column layout (Quick Links, About, Contact)
     - Renders children via `<Outlet />`
   - AND wrapped in ErrorBoundary with appropriate fallback

3. **AC3: AuthLayout Component (ADR-016)**
   - GIVEN a visitor on auth pages (/login, /register, /forgot-password, etc.)
   - WHEN the page renders
   - THEN AuthLayout MUST include:
     - Minimal chrome: "Back to Homepage" link top-left only
     - Centered content card with Oyo State logo (60px height)
     - NO header/footer navigation (focused auth experience)
     - Consistent background (neutral-50)
   - AND wrapped in ErrorBoundary with appropriate fallback

4. **AC4: Mobile Navigation**
   - GIVEN a mobile viewport (< 768px / below `md:` breakpoint)
   - WHEN visitor taps hamburger menu
   - THEN slide-in drawer MUST:
     - Animate from right (300ms ease-out)
     - Show all navigation items vertically
     - Include "Register Now" and "Staff Login" CTAs
     - Close on outside click or escape key
     - Trap focus within drawer when open (a11y)

5. **AC5: PageSkeleton Component**
   - GIVEN existing skeleton components in `apps/web/src/components/skeletons/`
   - WHEN implementing full-page loading states
   - THEN create `PageSkeleton` component:
     - Full page shimmer with header, content area, footer placeholders
     - Uses existing shimmer animation (already GPU-accelerated)
     - Matches Oyo State brand colors in gradient
   - NOTE: SkeletonCard, SkeletonText, SkeletonAvatar, SkeletonTable, SkeletonForm already exist - DO NOT recreate

6. **AC6: Route Structure Updated**
   - GIVEN the App.tsx router configuration
   - WHEN I add PublicLayout and AuthLayout
   - THEN routes MUST be organized as:
     - Public pages wrapped in `<PublicLayout>`: `/`, `/about/*`, `/participate/*`, `/support/*`, `/terms`
     - Auth pages wrapped in `<AuthLayout>`: `/login`, `/register`, `/forgot-password`, `/reset-password/:token`, `/verify-email/:token`, `/staff/login`, `/resend-verification`
     - Protected pages remain as-is (dashboard layout in future epic)
   - NOTE: Current routes use `/register` NOT `/auth/register` - maintain this pattern

7. **AC7: WCAG 2.1 AA Compliance**
   - GIVEN all new components
   - WHEN tested with accessibility tools
   - THEN MUST pass:
     - Color contrast ratios (4.5:1 minimum for text)
     - Touch targets minimum 44x44px on mobile
     - Keyboard navigation for all interactive elements
     - Focus indicators visible (2px Primary-500 outline)
     - Skip link: "Skip to main content" after logo

## Tasks / Subtasks

- [x] **Task 1: Extend Design Tokens & Font Loading** (AC: 1)
  - [x] 1.1 Add Google Fonts link to `index.html` (Poppins, Inter, JetBrains Mono) with `font-display: swap`
  - [x] 1.2 Add full typography scale variables to index.css (H2, H3, H4, Body Large, Body Small, Caption)
  - [x] 1.3 Add `--font-mono: "JetBrains Mono", monospace` to index.css
  - [x] 1.4 Add spacing scale (--spacing-1: 4px through --spacing-16: 64px)
  - [x] 1.5 Verify all semantic colors present and WCAG compliant

- [x] **Task 2: Create PublicLayout Component** (AC: 2, 4, 7)
  - [x] 2.1 Create `apps/web/src/layouts/PublicLayout.tsx` wrapped in ErrorBoundary
  - [x] 2.2 Create `apps/web/src/layouts/components/Header.tsx`
  - [x] 2.3 Create `apps/web/src/layouts/components/Footer.tsx`
  - [x] 2.4 Install shadcn Sheet: `pnpm dlx shadcn@latest add sheet`
  - [x] 2.5 Create `apps/web/src/layouts/components/MobileNav.tsx` using Sheet component
  - [x] 2.6 Install shadcn NavigationMenu: `pnpm dlx shadcn@latest add navigation-menu`
  - [x] 2.7 Create `apps/web/src/layouts/components/NavDropdown.tsx` using NavigationMenu
  - [x] 2.8 Create `apps/web/src/layouts/components/SkipLink.tsx` for accessibility
  - [x] 2.9 Add co-located tests: `Header.test.tsx`, `Footer.test.tsx`, `MobileNav.test.tsx`

- [x] **Task 3: Create AuthLayout Component** (AC: 3, 7)
  - [x] 3.1 Create `apps/web/src/layouts/AuthLayout.tsx` wrapped in ErrorBoundary
  - [x] 3.2 Style centered card with logo (reference existing auth pages for pattern)
  - [x] 3.3 Add "Back to Homepage" link using existing Link component
  - [x] 3.4 Add co-located test: `AuthLayout.test.tsx`

- [x] **Task 4: Create PageSkeleton Component** (AC: 5)
  - [x] 4.1 Create `apps/web/src/components/skeletons/PageSkeleton.tsx`
  - [x] 4.2 Compose using existing SkeletonCard, SkeletonText components
  - [x] 4.3 Add co-located test: `PageSkeleton.test.tsx`
  - [x] 4.4 Export from `apps/web/src/components/skeletons/index.tsx`

- [x] **Task 5: Update Route Structure** (AC: 6)
  - [x] 5.1 Wrap public routes in PublicLayout (/, /about/*, /participate/*, /support/*, /terms)
  - [x] 5.2 Wrap auth routes in AuthLayout (/login, /register, /forgot-password, etc.)
  - [x] 5.3 Add placeholder routes for /about, /participate, /support, /terms (empty components)
  - [x] 5.4 Create `apps/web/src/layouts/index.ts` barrel export

- [x] **Task 6: Testing & Validation** (AC: 7)
  - [x] 6.1 Run `pnpm test` - 235 tests pass (11 new NavDropdown tests added)
  - [x] 6.2 Run ESLint - passes with no warnings/errors
  - [x] 6.3 Build verification - TypeScript compiles successfully
  - [x] 6.4 Manual browser test: Mobile responsive breakpoints, keyboard navigation verified by user

## Dev Notes

### Existing Foundation (from Epic 1) - DO NOT RECREATE

**Design Tokens already in `apps/web/src/index.css`:**
- Color palette: `--color-primary-*`, `--color-success-*`, `--color-warning-*`, `--color-error-*`, `--color-info-*`, `--color-neutral-*`
- Font families: `--font-brand` (Poppins), `--font-ui` (Inter)
- Typography: `--text-h1` with line-height and font-weight
- Shimmer animation (GPU-accelerated)

**Skeleton Components already in `apps/web/src/components/skeletons/`:**
- SkeletonAvatar, SkeletonCard, SkeletonForm, SkeletonTable, SkeletonText
- Only `PageSkeleton` needs creation - compose from existing components

**What MUST be added:**
- `--font-mono` variable for JetBrains Mono
- Typography scale: H2, H3, H4, Body Large, Body Small, Caption
- Spacing scale: --spacing-1 (4px) through --spacing-16 (64px)
- Google Fonts link in index.html

### Architecture Constraints (ADR-016)

**Layout Hierarchy per project-context.md:**
```
PublicLayout (/, /about/*, /participate/*, /support/*, /terms, /marketplace)
├── ErrorBoundary wrapper
├── SkipLink ("Skip to main content")
├── Header (logo + nav + mobile hamburger)
├── <main id="main-content"><Outlet /></main>
└── Footer (3-column)

AuthLayout (/login, /register, /forgot-password, /reset-password/:token, /verify-email/:token, /staff/login)
├── ErrorBoundary wrapper
├── "← Back to Homepage" link (top-left)
├── Logo (60px, centered)
└── Auth card content
```

**Navigation Structure (per public-website-ia.md Section 2):**
```
Header:
├── Logo (links to /)
├── About (dropdown: The Initiative, How It Works, Leadership, Partners, Privacy)
├── Participate (dropdown: For Workers, For Employers)
├── Support (links to /support)
├── Marketplace (links to /marketplace - placeholder for Epic 7)
├── [Mobile < 768px: Hamburger menu using Sheet component]
└── CTAs: "Register" (primary button), "Staff Login" (ghost button)

Footer:
├── Column 1 (Quick Links): Home, About, Participate, Support, Marketplace
├── Column 2 (Legal): Terms of Service, Privacy Policy, Contact
├── Column 3 (Contact): Ministry address, Email, Phone
└── Copyright: © 2026 Oyo State Government
```

### Project Structure

**New files to create:**
```
apps/web/src/
├── layouts/
│   ├── index.ts                    # Barrel export
│   ├── PublicLayout.tsx            # Main public layout
│   ├── AuthLayout.tsx              # Minimal auth layout
│   └── components/
│       ├── Header.tsx              # Shared header
│       ├── Header.test.tsx         # Co-located test
│       ├── Footer.tsx              # Shared footer
│       ├── Footer.test.tsx         # Co-located test
│       ├── MobileNav.tsx           # Mobile slide-in drawer (uses shadcn Sheet)
│       ├── MobileNav.test.tsx      # Co-located test
│       ├── NavDropdown.tsx         # Desktop dropdown (uses shadcn NavigationMenu)
│       └── SkipLink.tsx            # Accessibility skip link
├── components/skeletons/
│   ├── PageSkeleton.tsx            # NEW: Full page skeleton
│   └── PageSkeleton.test.tsx       # Co-located test
```

**Existing files to modify:**
- `apps/web/index.html` - Add Google Fonts link
- `apps/web/src/index.css` - Extend design tokens
- `apps/web/src/App.tsx` - Update route structure with layouts

### Library/Framework Requirements

**Already installed - DO NOT ADD:**
- React Router v7 (routing)
- sonner (toast notifications)
- Tailwind CSS v4 (styling)
- shadcn/ui base (Radix UI primitives)

**Install via shadcn CLI (NOT direct Radix):**
```bash
pnpm dlx shadcn@latest add sheet           # For MobileNav drawer
pnpm dlx shadcn@latest add navigation-menu # For desktop dropdowns
```

### Font Loading Strategy

Add to `apps/web/index.html` in `<head>`:
```html
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
```

### Testing Requirements

**Test Organization: Co-located tests (frontend pattern per project-context.md)**
- Place test files next to component files
- Example: `Header.tsx` → `Header.test.tsx` in same folder

**Unit Tests:**
- PublicLayout renders header, outlet, footer
- AuthLayout renders back link, logo, children
- MobileNav opens/closes correctly, traps focus
- NavDropdown keyboard navigation works (Arrow keys, Enter, Escape)
- SkipLink focuses main content on activation

**Integration Tests:**
- Route transitions maintain correct layout
- Mobile nav closes on route change

### ErrorBoundary Integration

Wrap layouts per project-context.md Section 4a:
```typescript
// PublicLayout.tsx
import { ErrorBoundary } from '@/components/ErrorBoundary';

export function PublicLayout() {
  return (
    <ErrorBoundary
      fallbackProps={{
        title: 'Page Error',
        description: 'This page encountered an error. Please try again.',
      }}
    >
      <SkipLink />
      <Header />
      <main id="main-content">
        <Outlet />
      </main>
      <Footer />
    </ErrorBoundary>
  );
}
```

### References

- [Source: _bmad-output/project-context.md#Layout Architecture (ADR-016)]
- [Source: _bmad-output/project-context.md#Loading States (Skeleton Screens)]
- [Source: _bmad-output/project-context.md#Error Boundaries]
- [Source: _bmad-output/planning-artifacts/ux-design-specification.md#Design System Foundation]
- [Source: docs/public-website-ia.md#Section 2 - Navigation]
- [Source: apps/web/src/index.css - Existing design tokens]
- [Source: apps/web/src/components/skeletons/ - Existing skeleton components]
- [Source: apps/web/src/App.tsx - Current route structure]

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

- Fixed shadcn component imports from `@/lib/utils` to relative paths (`../../lib/utils`)
- Fixed AuthLayout test route matching (changed from `/login` to `/` path)
- Modified CSS class selectors in tests to use attribute selectors for Tailwind classes

### Completion Notes List

1. **Design Tokens Extended**: Added full typography scale (H2-Caption), --font-mono, and spacing scale (1-16) to index.css
2. **Google Fonts**: Added Poppins, Inter, JetBrains Mono with preconnect and font-display: swap
3. **PublicLayout**: Created with Header, Footer, MobileNav, NavDropdown, and SkipLink components
4. **AuthLayout**: Created minimal auth layout with back link and centered logo
5. **PageSkeleton**: Created composable page skeleton with variants (default, cards, form)
6. **Route Structure**: Updated App.tsx with nested routes for PublicLayout and AuthLayout
7. **shadcn Components**: Installed Sheet and NavigationMenu components
8. **Tests**: All 224 tests pass, including 6 new test files for layout components

### Change Log

| Date | Change | Author |
|------|--------|--------|
| 2026-01-23 | Replaced placeholder logos with actual Oyo State logo (Header, Footer, AuthLayout); Task 6.4 manual testing verified | User + Claude Opus 4.5 |
| 2026-01-23 | Code review fixes: H2-anchor tags, H1-animation timing, C2-duplicate close, M1-escape handler, M3-footer column, M4-spacing scale, H3-NavDropdown tests, nested anchor fix in NavDropdown | Claude Opus 4.5 (Code Review) |
| 2026-01-23 | Story implementation complete - all tasks done | Claude Opus 4.5 (Dev Agent) |
| 2026-01-23 | Story validated and improved by PM agent (John) | Claude Opus 4.5 |
| 2026-01-22 | Story created by SM agent (Bob) | Claude Opus 4.5 |

### File List

**Created:**
- `apps/web/src/layouts/index.ts` - Barrel export for layouts
- `apps/web/src/layouts/PublicLayout.tsx` - Public pages layout wrapper
- `apps/web/src/layouts/AuthLayout.tsx` - Auth pages layout wrapper
- `apps/web/src/layouts/AuthLayout.test.tsx` - AuthLayout tests (10 tests)
- `apps/web/src/layouts/components/Header.tsx` - Global header with nav
- `apps/web/src/layouts/components/Header.test.tsx` - Header tests (6 tests)
- `apps/web/src/layouts/components/Footer.tsx` - 3-column footer
- `apps/web/src/layouts/components/Footer.test.tsx` - Footer tests (8 tests)
- `apps/web/src/layouts/components/MobileNav.tsx` - Mobile slide-in drawer
- `apps/web/src/layouts/components/MobileNav.test.tsx` - MobileNav tests (9 tests)
- `apps/web/src/layouts/components/NavDropdown.tsx` - Desktop dropdown navigation
- `apps/web/src/layouts/components/NavDropdown.test.tsx` - NavDropdown tests (11 tests) [Added by code review]
- `apps/web/src/layouts/components/SkipLink.tsx` - Accessibility skip link
- `apps/web/src/components/skeletons/PageSkeleton.tsx` - Full page skeleton
- `apps/web/src/components/skeletons/PageSkeleton.test.tsx` - PageSkeleton tests (12 tests)
- `apps/web/src/components/ui/sheet.tsx` - shadcn Sheet component
- `apps/web/src/components/ui/navigation-menu.tsx` - shadcn NavigationMenu component
- `apps/web/components.json` - shadcn configuration

**Modified:**
- `apps/web/index.html` - Added Google Fonts (lines 20-23)
- `apps/web/src/index.css` - Extended design tokens (typography, spacing, --font-mono)
- `apps/web/src/App.tsx` - Updated route structure with layouts
- `apps/web/src/components/skeletons/index.tsx` - Added PageSkeleton export
- `apps/web/package.json` - Updated dependencies (shadcn installs)
- `apps/web/src/lib/utils.ts` - Updated by shadcn CLI
- `pnpm-lock.yaml` - Updated lockfile (shadcn dependencies)
