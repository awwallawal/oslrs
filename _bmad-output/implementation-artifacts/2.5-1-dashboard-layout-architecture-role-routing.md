# Story 2.5-1: Dashboard Layout Architecture & Role-Based Routing

**Epic:** 2.5 - Role-Based Dashboards & Feature Integration
**Status:** done
**Created:** 2026-01-31
**Priority:** P0 (Blocks all other Epic 2.5 stories)

---

## Story Overview

As a System Architect,
I want the DashboardLayout component and role-based routing infrastructure,
So that each role lands on their appropriate dashboard with correct navigation and route protection.

---

## Dependencies

### Required (Complete)
- Epic 1: Foundation - Authentication, RBAC middleware, user roles
- Epic 1.5: Public Website - PublicLayout, AuthLayout, design system
- Epic 2: ODK Integration - Backend APIs ready for dashboard integration
- Story 1.9: Global UI Patterns - Skeleton components, loading states

### Existing Assets to Leverage
| Asset | Location | Purpose |
|-------|----------|---------|
| `ProtectedRoute` | `apps/web/src/features/auth/components/ProtectedRoute.tsx` | RBAC route protection, already supports `allowedRoles` |
| `PublicOnlyRoute` | Same file | Redirect authenticated users away from auth pages |
| `RoleGate` | Same file | Conditionally render UI elements by role |
| `useAuth` | `apps/web/src/features/auth/context/AuthContext.tsx` | Access `user.role`, `isAuthenticated` |
| `AuthLayout` | `apps/web/src/layouts/AuthLayout.tsx` | Reference for layout architecture |
| `PublicLayout` | `apps/web/src/layouts/PublicLayout.tsx` | Reference for layout architecture |
| Skeleton components | `apps/web/src/components/skeletons/` | Loading states |
| shadcn/ui | `apps/web/src/components/ui/` | Sheet, NavigationMenu, Card |

---

## Acceptance Criteria

### AC1: DashboardLayout Component
**Given** ADR-016 layout patterns
**When** a user navigates to `/dashboard/*`
**Then** DashboardLayout renders with role-appropriate sidebar

**Implementation Requirements:**
- Enumerator/Public User: 3-4 sidebar items (mobile-first)
- Supervisor: 6-8 sidebar items
- Super Admin: 12+ sidebar items
- Desktop: Fixed left sidebar (240px width)
- Mobile: Bottom navigation bar (56px height) or hamburger menu

### AC2: Root Dashboard Redirect
**Given** a logged-in user with role X
**When** they access the root `/dashboard` route
**Then** they are redirected to their role-specific home

**Role → Route Mapping:**
| Role | Redirect Target |
|------|-----------------|
| `super_admin` | `/dashboard/super-admin` |
| `supervisor` | `/dashboard/supervisor` |
| `enumerator` | `/dashboard/enumerator` |
| `clerk` | `/dashboard/clerk` |
| `assessor` | `/dashboard/assessor` |
| `official` | `/dashboard/official` |
| `public_user` | `/dashboard/public` |

### AC3: RBAC Route Isolation (Strict)
**Given** the existing `useAuth()` hook and RBAC middleware
**When** a user attempts to access another role's route
**Then** they are denied access and redirected to the unauthorized page

**Note:** As a SPA, there is no HTTP 403 response. The `ProtectedRoute` component performs client-side role validation and redirects unauthorized users.

**Test Matrix (7x7 = 49 test cases):**
- Each role accessing their own route: ALLOW (7 tests)
- Each role accessing other roles' routes: DENY with redirect (42 tests)
- This ensures strict route isolation per Epic 2.5 security model

**Redirect Behavior:**
```
User role: enumerator
Attempts: /dashboard/super-admin
Result: Access denied → Redirect to /unauthorized
```

### AC4: Sidebar Active State
**Given** the sidebar navigation component
**When** a user clicks a nav item
**Then** the active state is visually indicated and the route loads in the main content area

**Visual Indicators:**
- Active item: Primary color background, white text, left border indicator
- Hover state: Subtle background change
- Focus state: Visible focus ring for accessibility

### AC5: Dynamic Sidebar Items
**Given** the UX spec requirement for role-specific navigation
**Then** sidebar items are dynamically rendered based on `user.role` with icons from the design system

**Sidebar Configuration by Role:**

| Role | Nav Items | Icon Examples |
|------|-----------|---------------|
| Enumerator | Home, Start Survey, Drafts, Sync Status | Home, FileText, Save, RefreshCw |
| Public User | Home, Survey Status, Marketplace, Support | Home, ClipboardList, Briefcase, HelpCircle |
| Clerk | Home, Entry Queue, Completed, My Stats | Home, ListOrdered, CheckSquare, BarChart |
| Supervisor | Home, Team Progress, Fraud Alerts, Messages | Home, Users, AlertTriangle, MessageSquare |
| Assessor | Home, Audit Queue, Completed, Evidence | Home, FileSearch, CheckCircle, Shield |
| Official | Home, Statistics, Trends, Export | Home, PieChart, TrendingUp, Download |
| Super Admin | Home, Staff, Questionnaires, ODK Health, System, Settings, Audit Logs, ... | (12+ items) |

### AC6: Header & Profile Dropdown
**Given** the Oyo State branding guidelines
**Then** DashboardLayout includes:
- Header with OSLSR logo (links to dashboard home)
- User dropdown with:
  - User name display
  - Avatar (initials if no photo)
  - "My Profile" link
  - "Logout" button (red text)
- Mobile: Bottom navigation with profile icon

**Header Height:** 64px desktop, 56px mobile

### AC7: Skeleton Loading States
**Given** the UX spec loading state requirements
**When** any dashboard data is being fetched
**Then** skeleton screens (shimmer effect in Oyo brand colors) MUST be displayed instead of spinners

**Leverage Existing:**
- `PageSkeleton` component from Story 1.9
- `SkeletonCard`, `SkeletonTable` for dashboard widgets
- Shimmer animation: Oyo State Red gradient (#9C1E23 → lighter tone)

---

## Technical Implementation

### File Structure

```
apps/web/src/
├── layouts/
│   ├── DashboardLayout.tsx          # NEW - Main dashboard layout
│   ├── DashboardLayout.test.tsx     # NEW - Layout tests
│   ├── components/
│   │   ├── DashboardSidebar.tsx     # NEW - Sidebar component
│   │   ├── DashboardHeader.tsx      # NEW - Header with profile dropdown
│   │   ├── DashboardBottomNav.tsx   # NEW - Mobile bottom navigation
│   │   ├── ProfileDropdown.tsx      # NEW - User menu dropdown
│   │   └── SidebarNav.tsx           # NEW - Nav items renderer
│   └── index.ts                     # MODIFY - Export DashboardLayout
├── features/
│   └── dashboard/
│       ├── components/
│       │   └── DashboardRedirect.tsx  # NEW - Role-based redirect
│       ├── config/
│       │   └── sidebarConfig.ts       # NEW - Per-role nav items
│       └── index.ts
└── App.tsx                          # MODIFY - Add dashboard routes
```

### Key Patterns

#### 1. Sidebar Configuration Pattern
```typescript
// apps/web/src/features/dashboard/config/sidebarConfig.ts
import { Home, FileText, Users, AlertTriangle } from 'lucide-react';

type UserRole = 'super_admin' | 'supervisor' | 'enumerator' | 'clerk' | 'assessor' | 'official' | 'public_user';

interface NavItem {
  label: string;
  href: string;
  icon: LucideIcon;
  badge?: number; // For notification counts
}

export const sidebarConfig: Record<UserRole, NavItem[]> = {
  enumerator: [
    { label: 'Home', href: '/dashboard/enumerator', icon: Home },
    { label: 'Start Survey', href: '/dashboard/enumerator/survey', icon: FileText },
    { label: 'Drafts', href: '/dashboard/enumerator/drafts', icon: Save },
    { label: 'Sync Status', href: '/dashboard/enumerator/sync', icon: RefreshCw },
  ],
  // ... other roles
};
```

#### 2. Dashboard Route Guard Pattern
```typescript
// Extend ProtectedRoute for role-specific dashboard access
<Route
  path="dashboard"
  element={
    <ProtectedRoute redirectTo="/login">
      <DashboardLayout />
    </ProtectedRoute>
  }
>
  {/* Child routes with role checks */}
  <Route index element={<DashboardRedirect />} />
  <Route
    path="super-admin/*"
    element={
      <ProtectedRoute allowedRoles={['super_admin']} redirectTo="/dashboard">
        <Outlet />
      </ProtectedRoute>
    }
  >
    <Route index element={<SuperAdminHome />} />
    {/* ... */}
  </Route>
</Route>
```

#### 3. DashboardRedirect Component
```typescript
// apps/web/src/features/dashboard/components/DashboardRedirect.tsx
const roleRouteMap: Record<string, string> = {
  super_admin: '/dashboard/super-admin',
  supervisor: '/dashboard/supervisor',
  enumerator: '/dashboard/enumerator',
  clerk: '/dashboard/clerk',
  assessor: '/dashboard/assessor',
  official: '/dashboard/official',
  public_user: '/dashboard/public',
};

export function DashboardRedirect() {
  const { user } = useAuth();
  const targetRoute = roleRouteMap[user?.role ?? ''] || '/unauthorized';
  return <Navigate to={targetRoute} replace />;
}
```

### Responsive Breakpoints

| Breakpoint | Behavior |
|------------|----------|
| < 768px (mobile) | Bottom navigation, hamburger for full nav |
| 768px - 1024px (tablet) | Collapsible sidebar, icons only |
| > 1024px (desktop) | Full sidebar with labels |

### Accessibility Requirements (WCAG 2.1 AA)

- Focus management: Sidebar items receive keyboard focus
- ARIA labels: `aria-current="page"` for active nav item
- Skip link: "Skip to main content" at top of dashboard
- Color contrast: 4.5:1 minimum for text
- Touch targets: 44px minimum on mobile

---

## Test Requirements

### Unit Tests
1. `DashboardLayout` renders sidebar for each role (7 tests)
2. `ProfileDropdown` shows logout and profile links
3. `SidebarNav` highlights active route
4. `DashboardRedirect` navigates to correct role route (7 tests)

### Integration Tests
5. RBAC route protection matrix (49 tests - 7x7):
   - Each role accessing own dashboard: 200 OK
   - Each role accessing other dashboards: 403 → redirect
6. Logout flow clears session and redirects to `/login`
7. Mobile bottom nav shows/hides at breakpoint

### Test File Location
```
apps/web/src/layouts/__tests__/DashboardLayout.test.tsx
apps/web/src/features/dashboard/__tests__/DashboardRedirect.test.tsx
apps/web/src/features/dashboard/__tests__/rbac-routes.test.tsx  # 49 matrix tests
```

---

## Wireframe Reference

See: `_bmad-output/wireframes/dashboard-*.excalidraw`

All wireframes include:
- Profile menu dropdown with avatar
- "My Profile" option
- "Logout" option (red text)
- Role-specific sidebar navigation

---

## Definition of Done

- [x] DashboardLayout component renders with sidebar/header/content areas
- [x] All 7 role route mappings configured in App.tsx
- [x] `/dashboard` root redirects to role-specific home
- [x] RBAC protection on all `/dashboard/{role}/*` routes
- [x] Sidebar items render dynamically based on user role
- [x] Active nav item visually indicated
- [x] Profile dropdown with logout functionality
- [x] Mobile bottom navigation functional
- [x] Skeleton loading states display during data fetch
- [x] All unit tests pass (14+ tests) - 99 new tests added
- [x] RBAC matrix tests pass (49 tests) - 53 RBAC tests
- [x] Responsive design verified at mobile/tablet/desktop
- [x] WCAG 2.1 AA accessibility verified (skip link, aria-labels, focus states)

---

## Developer Notes

### Quick Start
```bash
# Create the DashboardLayout component
pnpm --filter @oslsr/web generate component layouts/DashboardLayout

# Run tests in watch mode
pnpm --filter @oslsr/web test -- --watch DashboardLayout
```

### Key Files to Reference
- Existing `AuthLayout.tsx` for layout patterns
- `ProtectedRoute.tsx` for RBAC implementation
- `sidebarConfig.ts` drives all nav item rendering
- `useAuth()` provides `user.role` for conditional rendering

### Gotchas
1. **Route nesting**: Dashboard child routes must use `<Outlet />` for nested rendering
2. **Role type**: User role from backend is snake_case (`public_user`), ensure consistency
3. **403 redirect**: When redirecting unauthorized users, preserve their intended destination in state for potential error message display
4. **Mobile nav**: Bottom nav items should be limited to 4-5 most important items

---

## Story Points: 8

**Complexity Factors:**
- New layout architecture (DashboardLayout)
- 7 role configurations
- 49 RBAC test cases
- Responsive design (3 breakpoints)
- Accessibility requirements

**Risk:** Low (patterns established in Epic 1.5)

---

## References

- ADR-016: Layout Architecture
- UX Design Specification: Section 3 (Role-specific navigation)
- Wireframes: `_bmad-output/wireframes/dashboard-*.excalidraw`
- Epic 2 Retrospective: Decision 3 (RBAC Route Isolation Pattern)

---

## Dev Agent Record

### Implementation Plan
- Created sidebar configuration with per-role nav items (sidebarConfig.ts)
- Implemented DashboardLayout with sidebar, header, and mobile bottom nav
- Created ProfileDropdown with logout functionality
- Added DashboardRedirect for role-based routing
- Updated App.tsx with all 7 role-specific routes with RBAC protection
- Created placeholder dashboard home pages for all 7 roles
- Added comprehensive test suite (99 new tests)

### Completion Notes
**Date:** 2026-01-31

**Implementation Summary:**
- AC1: DashboardLayout with responsive sidebar (240px desktop, hidden mobile)
- AC2: DashboardRedirect routes users to role-specific dashboards
- AC3: Strict RBAC isolation - 49 test cases validating cross-role access denied
- AC4: NavLink active state with primary color background and border indicator
- AC5: sidebarConfig.ts provides role-specific nav items (4-12+ items per role)
- AC6: ProfileDropdown with avatar initials, role badge, My Profile, Logout
- AC7: Skeleton loading states during auth loading

**Tests Added:**
- DashboardLayout.test.tsx: 15 tests (layout, sidebar, dropdown, skeleton)
- DashboardRedirect.test.tsx: 9 tests (7 role redirects + auth states)
- rbac-routes.test.tsx: 53 tests (49 RBAC matrix + 4 security validation)
- sidebarConfig.test.ts: 23 tests (config completeness, helper functions)

**Total:** 577 tests pass (99 new)

---

## File List

### New Files
- `apps/web/src/features/dashboard/config/sidebarConfig.ts` - Sidebar configuration per role
- `apps/web/src/features/dashboard/index.ts` - Feature module exports
- `apps/web/src/features/dashboard/components/DashboardRedirect.tsx` - Role-based redirect
- `apps/web/src/features/dashboard/pages/SuperAdminHome.tsx` - Super Admin placeholder
- `apps/web/src/features/dashboard/pages/SupervisorHome.tsx` - Supervisor placeholder
- `apps/web/src/features/dashboard/pages/EnumeratorHome.tsx` - Enumerator placeholder
- `apps/web/src/features/dashboard/pages/ClerkHome.tsx` - Clerk placeholder
- `apps/web/src/features/dashboard/pages/AssessorHome.tsx` - Assessor placeholder
- `apps/web/src/features/dashboard/pages/OfficialHome.tsx` - Official placeholder
- `apps/web/src/features/dashboard/pages/PublicUserHome.tsx` - Public User placeholder
- `apps/web/src/features/dashboard/pages/ProfilePage.tsx` - Profile page
- `apps/web/src/layouts/DashboardLayout.tsx` - Main dashboard layout
- `apps/web/src/layouts/components/DashboardSidebar.tsx` - Desktop sidebar
- `apps/web/src/layouts/components/DashboardHeader.tsx` - Dashboard header
- `apps/web/src/layouts/components/DashboardBottomNav.tsx` - Mobile bottom nav
- `apps/web/src/layouts/components/ProfileDropdown.tsx` - User menu dropdown
- `apps/web/src/layouts/components/SidebarNav.tsx` - Nav items renderer
- `apps/web/src/layouts/__tests__/DashboardLayout.test.tsx` - Layout tests
- `apps/web/src/features/dashboard/__tests__/DashboardRedirect.test.tsx` - Redirect tests
- `apps/web/src/features/dashboard/__tests__/rbac-routes.test.tsx` - RBAC matrix tests
- `apps/web/src/features/dashboard/__tests__/sidebarConfig.test.ts` - Config tests

### Modified Files
- `apps/web/src/layouts/index.ts` - Added DashboardLayout export
- `apps/web/src/App.tsx` - Added dashboard routes with RBAC protection
- `apps/web/src/components/skeletons/PageSkeleton.tsx` - Added 'dashboard' variant
- `apps/web/src/layouts/DashboardLayout.tsx` - Uses LAYOUT constants for sheet width
- `apps/web/src/layouts/components/DashboardSidebar.tsx` - Uses APP_VERSION constant
- `apps/web/src/layouts/components/DashboardBottomNav.tsx` - Fixed badge positioning with relative
- `apps/web/src/features/dashboard/config/sidebarConfig.ts` - Changed ODK Health icon to HeartPulse
- `apps/web/src/lib/constants.ts` - NEW: Centralized layout constants and version
- `package.json` - Updated dependencies (if any)

### Supporting Files (Test Infrastructure)
- `scripts/` - Test helper scripts
- `test-fixtures/` - Test fixture data
- `.vitest-config-loaded` - Vitest configuration marker

---

## Change Log

| Date | Change | Author |
|------|--------|--------|
| 2026-01-31 | Story implementation complete - DashboardLayout, role routing, RBAC protection, 99 tests | Dev Agent |
| 2026-01-31 | Code review fixes: H2 badge positioning, H5 duplicate icon, M2 skip link test, AC3 wording, File List update | Dev Agent (Review) |
| 2026-01-31 | LOW issue fixes: L1 version constant (APP_VERSION), L2 layout constants (LAYOUT.MOBILE_SHEET_WIDTH_CLASS) | Dev Agent (Review) |

---

## Status

**Status:** done
