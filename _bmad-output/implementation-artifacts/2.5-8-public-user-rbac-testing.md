# Story 2.5.8: Public User Dashboard & RBAC Integration Testing

Status: done

## Story

As a Public User,
I want my simple dashboard with profile status and Insights placeholder,
So that I can access public features and know my next steps.

As a Developer/QA,
I want comprehensive RBAC integration tests,
So that we can verify all role routes are properly protected.

## Acceptance Criteria

**Public User Dashboard (`/dashboard/public`):**

1. **Given** a Public User at `/dashboard/public`, **when** the page loads, **then** they see a simple, mobile-first dashboard with profile completion status, "Complete Survey" CTA, marketplace opt-in status, and "Coming Soon: Skills Marketplace Insights" teaser.
2. **Given** the UX spec mobile-first requirement for public users, **then** the dashboard is optimized for mobile with minimal complexity.
3. **Given** the public user's limited scope, **then** navigation shows only: Home, Survey Status, Marketplace, Support (4 sidebar items — already configured in `sidebarConfig.ts`). Home is the dashboard index route; the other 3 are sub-pages to be created.
4. **Given** a Public User attempts to access any `/dashboard/*` route except `/dashboard/public`, **then** they receive 403 Forbidden (via `ProtectedRoute` → redirect to `/unauthorized`).

**RBAC Integration Testing (Cross-Role):**

5. **Given** all 7 role dashboards are implemented, **when** running RBAC integration tests, **then** the access matrix verifies each role can ONLY access their own routes (strict isolation). **NOTE:** Already covered by `rbac-routes.test.tsx` (49 matrix + 4 security = 53 existing tests). This AC is to verify coverage and add any missing public_user-specific edge cases.
6. **Given** the RBAC integration tests, **then** they run in CI on every PR and block merge if any role can access unauthorized routes. **NOTE:** Tests already run via `pnpm test` in CI. No additional CI config needed.
7. **Given** any RBAC violation attempt, **when** it occurs, **then** it is logged to audit trail with: attempted route, user ID, role, timestamp. **NOTE:** Audit trail is a backend concern (Epic 6, Story 6-1). Frontend `ProtectedRoute` already redirects to `/unauthorized`. Audit logging will be wired when backend audit trail is implemented. For now, add a TODO comment in ProtectedRoute noting the audit requirement.
8. **(DEFERRED — Epic 6)** **Given** RBAC violation logging, **when** integration tests run, **then** they verify both the 403 response AND that an audit log entry was created. **NOTE:** Backend audit trail not yet implemented (Epic 6, Story 6-1). For this story, only add a `.todo()` placeholder test — do NOT attempt to implement or assert audit log behavior.

## Tasks / Subtasks

- [x] Task 1: Implement PublicUserHome dashboard (AC: 1, 2, 3)
  - [x] 1.1 Replace placeholder in `PublicUserHome.tsx` with full mobile-first dashboard
  - [x] 1.2 Add `isLoading` prop (boolean, passed from parent `DashboardLayout` — see EnumeratorHome/ClerkHome for pattern) with SkeletonCard loading branch (same pattern as all other dashboards)
  - [x] 1.3 Add Profile Completion card (green, UserCheck icon) with progress indicator placeholder (e.g., "2 of 5 steps complete")
  - [x] 1.4 Add Complete Survey CTA card (blue, ClipboardList icon) with prominent "Start Survey" button → opens "Coming in Epic 3" modal
  - [x] 1.5 Add Marketplace Opt-In card (purple, Briefcase icon) with opt-in status placeholder and "Learn More" link → opens "Coming in Epic 7" modal
  - [x] 1.6 Add "Coming Soon: Skills Marketplace Insights" teaser section below cards (gray, Sparkles/TrendingUp icon, brief description of future feature)
  - [x] 1.7 Use 2-column grid on tablet (`md:grid-cols-2`), single column on mobile — NO 3-column grid (mobile-first per AC2)

- [x] Task 2: Add sub-pages for Public User (AC: 3)
  - [x] 2.1 Create `PublicSurveysPage.tsx` with empty-state pattern (ClipboardList icon, "Your survey history will appear here once you complete your first survey. Coming in Epic 3.")
  - [x] 2.2 Create `PublicMarketplacePage.tsx` with empty-state pattern (Briefcase icon, "Marketplace opt-in and profile management coming in Epic 7.")
  - [x] 2.3 Create `PublicSupportPage.tsx` with empty-state pattern (HelpCircle icon, "Support resources and FAQs will be available here.")

- [x] Task 3: Update App.tsx routes (AC: 3, 4)
  - [x] 3.1 Add lazy imports for 3 new sub-pages (PublicSurveysPage, PublicMarketplacePage, PublicSupportPage)
  - [x] 3.2 Add child routes under public path: `surveys`, `marketplace`, `support`
  - [x] 3.3 All sub-routes wrapped in `Suspense` + `DashboardLoadingFallback`
  - [x] 3.4 Keep existing `profile` route intact

- [x] Task 4: Write PublicUserHome tests (AC: 1, 2, 8)
  - [x] 4.1 Create `PublicUserHome.test.tsx` — test all 3 cards render with correct titles and icons
  - [x] 4.2 Test skeleton loading branch (`isLoading=true` renders SkeletonCards, hides content)
  - [x] 4.3 Test "Coming in Epic 3" modal opens on Survey CTA click and has Cancel + "Got it" buttons
  - [x] 4.4 Test "Coming in Epic 7" modal opens on Marketplace card interaction
  - [x] 4.5 Test "Coming Soon: Skills Marketplace Insights" teaser section renders
  - [x] 4.6 Test tab navigation — no interactive elements have negative tabindex

- [x] Task 5: Write sub-page tests (AC: 3)
  - [x] 5.1 Create `PublicUserSubPages.test.tsx` — test 3 sub-pages render with correct empty states
  - [x] 5.2 Each sub-page test: renders title, icon, description text

- [x] Task 6: RBAC verification & edge case tests (AC: 4, 5, 7, 8)
  - [x] 6.1 Verify `rbac-routes.test.tsx` already covers public_user in the 7x7 matrix (it does — 53 tests)
  - [x] 6.2 Add `PublicUserRbac.test.tsx` for public-user-specific edge cases:
    - Public user accessing `/dashboard/super-admin` → redirected to `/unauthorized`
    - Public user accessing `/dashboard/enumerator` → redirected to `/unauthorized`
    - Public user CAN access `/dashboard/public` → renders dashboard
  - [x] 6.3 Add `.todo()` placeholder test for audit trail logging verification (AC7, AC8) — blocked on Epic 6 backend
  - [x] 6.4 Update `sidebarConfig.test.ts` if any changes needed (currently covers public_user — verify: no changes needed)

### Review Follow-ups (AI) — Code Review 2026-02-10

- [x] [AI-Review][HIGH] H1: RBAC redirect state test was fake — rewrote to use `useLocation` and verify `state.from`/`state.requiredRoles` [PublicUserRbac.test.tsx:130-169]
- [x] [AI-Review][MEDIUM] M1: Sub-page icon tests used fragile CSS class selectors (.lucide-*) — replaced with generic SVG element checks [PublicUserSubPages.test.tsx:54,92,130]
- [x] [AI-Review][MEDIUM] M2: PublicUserHome icon background test used Tailwind class selectors — replaced with SVG icon count check [PublicUserHome.test.tsx:61-69]
- [x] [AI-Review][MEDIUM] M3: No RBAC test for public user sub-routes — added 3 tests for /surveys, /marketplace, /support [PublicUserRbac.test.tsx]
- [x] [AI-Review][LOW] L1: Redundant onClick handlers on AlertDialogAction — removed (Radix handles close via onOpenChange) [PublicUserHome.tsx:143,159]
- [x] [AI-Review][LOW] L2: Raw `<button>` elements replaced with shadcn/ui `<Button>` component for consistency [PublicUserHome.tsx:86-91,109-114]
- [x] [AI-Review][LOW] L3: Inline `style={{ width: '40%' }}` replaced with Tailwind `w-[40%]` class [PublicUserHome.tsx:65]

## Dev Notes

### Architecture Compliance

- **Loading states:** SkeletonCard components (NEVER spinners) — per project-context.md
- **Lazy loading:** All pages use `React.lazy()` + `<Suspense fallback={<DashboardLoadingFallback />}>` — established in Story 2.5-1
- **RBAC:** Routes guarded via `<ProtectedRoute allowedRoles={['public_user']}  redirectTo="/dashboard">` in App.tsx — already configured
- **Sidebar:** Already configured in `sidebarConfig.ts` with 4 items: Home, Survey Status, Marketplace, Support
- **Role mapping:** `public_user` already in `roleRouteMap`, `roleDisplayNames`, `ALL_ROLES`

### Mobile-First Design (Public User Specific)

The Public User dashboard is the only dashboard explicitly requiring **mobile-first** design (AC2). Key differences from other dashboards:

- **Grid:** Use `grid gap-6 md:grid-cols-2` (2-col max on tablet). Do NOT use `lg:grid-cols-3` — keep it simple
- **Typography:** Slightly larger touch targets, clear CTAs
- **Card count:** 3 cards (Profile, Survey, Marketplace) — fewer than staff dashboards
- **Tone:** Consumer-friendly, approachable. Use "My Dashboard", "Your profile", "Get started" — NOT formal government language
- **No Direction 08 styling** — that's Government Official only. Use standard card-based layout like EnumeratorHome

### Card Specifications

| Card | Icon | Icon BG | Icon Color | Content |
|------|------|---------|-----------|---------|
| Profile Completion | UserCheck | green-100 | green-600 | "2 of 5 steps complete" progress placeholder |
| Complete Survey | ClipboardList | blue-100 | blue-600 | "Start Survey" button → "Coming in Epic 3" modal |
| Marketplace Opt-In | Briefcase | purple-100 | purple-600 | Opt-in status + "Learn More" → "Coming in Epic 7" modal |

### Teaser Section (Below Cards)

Render the "Coming Soon" teaser as a subtle section below the main cards grid:

```
<div className="mt-8 p-6 bg-gray-50 rounded-lg border border-gray-200 text-center">
  <TrendingUp className="w-8 h-8 text-gray-400 mx-auto mb-3" />
  <h3 className="text-base font-medium text-gray-600 mb-1">
    Coming Soon: Skills Marketplace Insights
  </h3>
  <p className="text-sm text-gray-500 max-w-md mx-auto">
    Once you opt into the marketplace, you'll see how employers are finding your skills.
  </p>
</div>
```

### Modal Pattern (AlertDialog)

Reuse the exact pattern from OfficialHome.tsx / ClerkHome.tsx:

```tsx
const [showEpic3Modal, setShowEpic3Modal] = useState(false);
const [showEpic7Modal, setShowEpic7Modal] = useState(false);

<AlertDialog open={showEpic3Modal} onOpenChange={setShowEpic3Modal}>
  <AlertDialogContent>
    <AlertDialogHeader>
      <AlertDialogTitle>Coming in Epic 3</AlertDialogTitle>
      <AlertDialogDescription>
        Survey completion will be available once the native form renderer is integrated.
      </AlertDialogDescription>
    </AlertDialogHeader>
    <AlertDialogFooter>
      <AlertDialogCancel>Cancel</AlertDialogCancel>
      <AlertDialogAction>Got it</AlertDialogAction>
    </AlertDialogFooter>
  </AlertDialogContent>
</AlertDialog>
```

**CRITICAL:** Always include `<AlertDialogCancel>` — lesson from Story 2.5-6 code review (H1 fix).

### Sub-page Empty State Pattern

All sub-pages follow the established pattern from Stories 2.5-4 through 2.5-7:

```tsx
export default function PublicSurveysPage() {
  return (
    <div className="p-6">
      <h1 className="text-2xl font-brand font-semibold text-neutral-900 mb-6">Survey Status</h1>
      <div className="flex flex-col items-center justify-center py-16 text-center">
        <ClipboardList className="w-12 h-12 text-neutral-300 mb-4" />
        <h2 className="text-lg font-medium text-neutral-600 mb-2">No surveys yet</h2>
        <p className="text-neutral-500 text-sm max-w-md">
          Your survey history will appear here once you complete your first survey. Coming in Epic 3.
        </p>
      </div>
    </div>
  );
}
```

### Imports — Use These Exact Paths

```typescript
// UI components
import { Card, CardHeader, CardTitle, CardContent } from '../../../components/ui/card';
import { SkeletonCard } from '../../../components/skeletons';
import {
  AlertDialog, AlertDialogContent, AlertDialogHeader, AlertDialogTitle,
  AlertDialogDescription, AlertDialogFooter, AlertDialogAction, AlertDialogCancel
} from '../../../components/ui/alert-dialog';

// Icons (lucide-react) — for PublicUserHome
import { UserCheck, ClipboardList, Briefcase, TrendingUp } from 'lucide-react';

// Icons for sub-pages
import { HelpCircle } from 'lucide-react';

// React state (for modals)
import { useState } from 'react';
```

### RBAC Notes

**Already in place (DO NOT recreate):**
- `rbac-routes.test.tsx` — 7x7 full matrix (49 tests) + 4 security edge cases = 53 tests covering ALL role combinations including `public_user`
- `ProtectedRoute` component — handles role checking and redirects to `/unauthorized`
- `DashboardRedirect` — routes `public_user` → `/dashboard/public`
- `sidebarConfig.test.ts` — verifies public_user has 3-4 items

**New tests needed:**
- `PublicUserHome.test.tsx` — dashboard component tests (cards, modals, skeleton, icons)
- `PublicUserSubPages.test.tsx` — 3 sub-page empty state tests
- `PublicUserRbac.test.tsx` — public-user-specific RBAC edge cases (focused, not duplicating the matrix)

**Audit trail (AC7-8):** Backend audit trail is Epic 6 Story 6-1. Frontend cannot verify audit log entries yet. Add `it.todo('verifies audit log entry on RBAC violation (blocked on Epic 6)')` placeholder tests.

### What NOT To Do

- Do NOT modify `sidebarConfig.ts` — public_user config is already correct (4 items)
- Do NOT modify `DashboardLayout.tsx` — it already handles all roles
- Do NOT modify `rbac-routes.test.tsx` — it already has full public_user coverage in the matrix
- Do NOT use spinners — always SkeletonCard
- Do NOT use Direction 08 (formal government styling) — that's Official only
- Do NOT use `lg:grid-cols-3` — keep mobile-first with 2-col max
- Do NOT add real data fetching — all cards show placeholder data
- Do NOT implement actual survey, marketplace, or profile features — those are Epic 3 and Epic 7
- Do NOT use React 19 features — locked to React 18.3

### Project Structure Notes

Files to create/modify:
```
apps/web/src/
├── features/dashboard/pages/
│   ├── PublicUserHome.tsx              ← MODIFY (replace placeholder with full dashboard)
│   ├── PublicSurveysPage.tsx           ← CREATE
│   ├── PublicMarketplacePage.tsx       ← CREATE
│   ├── PublicSupportPage.tsx           ← CREATE
│   └── __tests__/
│       ├── PublicUserHome.test.tsx     ← CREATE
│       ├── PublicUserSubPages.test.tsx ← CREATE
│       └── PublicUserRbac.test.tsx     ← CREATE
├── App.tsx                             ← MODIFY (add lazy imports + 3 child routes; keep existing `profile` route intact)
```

### References

- [Source: _bmad-output/planning-artifacts/epics.md#Story 2.5-8] — Acceptance criteria and RBAC access matrix
- [Source: _bmad-output/planning-artifacts/architecture.md#ADR-016] — Layout architecture, strict role isolation
- [Source: _bmad-output/project-context.md] — Loading states, anti-patterns, testing org
- [Source: apps/web/src/features/dashboard/config/sidebarConfig.ts] — Sidebar already configured with 4 items
- [Source: apps/web/src/App.tsx#L837-863] — Routes already scaffolded with ProtectedRoute
- [Source: apps/web/src/features/dashboard/__tests__/rbac-routes.test.tsx] — Full 7x7 RBAC matrix already tested (53 tests)
- [Source: apps/web/src/features/dashboard/pages/PublicUserHome.tsx] — Current placeholder to replace

### Previous Story Intelligence (2.5-7)

From Story 2.5-7 (Assessor & Official Dashboards) code review:
- **AlertDialogCancel is required** — always include Cancel button in AlertDialog modals (inherited from 2.5-6 H1 fix)
- **Skeleton layout must match content shape** — skeleton grid should mirror the actual card grid layout (2.5-6 M5 fix)
- **Tab navigation testing** — test with `userEvent.tab()` to verify no focus traps (2.5-7 H2 fix: use actual tab traversal, not just tabindex attribute checks)
- **File list completeness** — always include `sprint-status.yaml` in File List section (2.5-6 M2 fix)
- **Role name mismatch bug** — All role names now use full DB/API names (`data_entry_clerk`, `verification_assessor`, `government_official`). The `public_user` name was never affected since it matched at both layers. No action needed here.
- **Icon class names** — lucide-react 0.378.0 aliases some icons. Test by visible text/role, not by icon class name (2.5-7 debug note: `CheckCircle` → `.lucide-circle-check-big`)
- **RBAC redirect assertions** — Test both the redirect to `/unauthorized` AND that redirect state contains `from` path and `requiredRoles` (2.5-7 M3 fix)

### Git Intelligence

Recent commit pattern: `feat: [Role] dashboard shell with code review fixes (Story X.X-X)`
- Last 4 stories (2.5-4 through 2.5-7) follow identical dashboard shell pattern
- Each adds home page + sub-pages + tests + App.tsx route updates
- All pass full web test regression suite (917 tests at last count after Story 2.5-7)
- Last commit: `1d11758` (Story 2.5-7) — 917 web tests passing

### Testing Standards

- **Framework:** Vitest + @testing-library/react + @testing-library/jest-dom
- **Location:** Co-located in `__tests__/` folder next to page components
- **Header:** `// @vitest-environment jsdom`
- **Pattern:** `vi.hoisted()` + `vi.mock()` for external deps (if needed — most dashboard tests don't need mocks)
- **Render helper:** Wrap in `<MemoryRouter>` for routing context (required for any component with `<a>` or router links)
- **AC mapping:** Each `describe` block maps to an AC number
- **Run:** `cd apps/web && pnpm vitest run` or `pnpm --filter @oslsr/web test`. NEVER `pnpm vitest run` from root.
- **Regression:** Must pass ALL existing 917+ tests plus new ones

## Change Log

- 2026-02-10: Story 2.5-8 implementation complete — Public User dashboard, 3 sub-pages, route wiring, 37 new tests (21 PublicUserHome + 12 sub-pages + 4 RBAC edge cases + 2 .todo() audit placeholders), TODO comment for audit trail in ProtectedRoute. All 956 web tests pass, 0 regressions.
- 2026-02-10: Code review — 7 findings (1H, 3M, 3L), all 7 fixed. H1 fake redirect state test rewritten with useLocation, M1 fragile icon CSS selectors replaced, M2 Tailwind class selectors replaced, M3 added 3 sub-route RBAC tests, L1 redundant onClick removed, L2 raw button → shadcn/ui Button, L3 inline style → Tailwind. 957 web tests pass (+3 new), 0 regressions.

## Dev Agent Record

### Agent Model Used

Claude Opus 4.6

### Debug Log References

- Test fix: `/Skills Marketplace/i` regex matched multiple elements (teaser + modal). Changed to `/employers discover your profile/i` for specificity.

### Completion Notes List

- Task 1: PublicUserHome.tsx already implemented (prior session). Verified all 7 subtasks against AC1/AC2. Mobile-first 2-col grid, 3 cards (Profile green/UserCheck, Survey blue/ClipboardList, Marketplace purple/Briefcase), SkeletonCard loading, AlertDialog modals with Cancel+Got it, "Coming Soon" teaser.
- Task 2: Created 3 sub-pages (PublicSurveysPage, PublicMarketplacePage, PublicSupportPage) with empty-state pattern matching existing dashboard sub-pages.
- Task 3: Added lazy imports + Suspense-wrapped routes (surveys, marketplace, support) under /dashboard/public in App.tsx. Existing profile route preserved.
- Task 4: Created PublicUserHome.test.tsx with 21 tests covering cards, skeleton loading, Epic 3 modal, Epic 7 modal, teaser section, and tab navigation.
- Task 5: Created PublicUserSubPages.test.tsx with 12 tests covering all 3 sub-pages' titles, icons, and description text.
- Task 6: Verified rbac-routes.test.tsx already covers public_user in 7x7 matrix (53 tests). Created PublicUserRbac.test.tsx with 4 passing tests + 2 .todo() placeholders for audit trail (Epic 6). Added TODO comment in ProtectedRoute.tsx for audit trail logging requirement. sidebarConfig.test.ts already covers public_user — no changes needed.

### File List

- apps/web/src/features/dashboard/pages/PublicUserHome.tsx (MODIFIED — full mobile-first dashboard, prior session)
- apps/web/src/features/dashboard/pages/PublicSurveysPage.tsx (CREATED)
- apps/web/src/features/dashboard/pages/PublicMarketplacePage.tsx (CREATED)
- apps/web/src/features/dashboard/pages/PublicSupportPage.tsx (CREATED)
- apps/web/src/features/dashboard/pages/__tests__/PublicUserHome.test.tsx (CREATED)
- apps/web/src/features/dashboard/pages/__tests__/PublicUserSubPages.test.tsx (CREATED)
- apps/web/src/features/dashboard/pages/__tests__/PublicUserRbac.test.tsx (CREATED)
- apps/web/src/App.tsx (MODIFIED — 3 lazy imports + 3 sub-routes for public user)
- apps/web/src/features/auth/components/ProtectedRoute.tsx (MODIFIED — added TODO comment for audit trail, AC7)
- _bmad-output/implementation-artifacts/sprint-status.yaml (MODIFIED — status update)
- _bmad-output/implementation-artifacts/2.5-8-public-user-rbac-testing.md (MODIFIED — task checkboxes, dev record, file list, change log, status)
