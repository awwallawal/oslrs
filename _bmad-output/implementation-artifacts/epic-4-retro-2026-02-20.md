# Epic 4 Retrospective: Supervisor Oversight & Field Management

**Date:** 2026-02-20
**Facilitator:** Bob (Scrum Master)
**Participants:** Alice (Product Owner), Charlie (Senior Dev), Dana (QA Engineer), Elena (Junior Dev), Awwal (Project Lead)
**Scope:** Prep-Epic-4 (11 stories) + Epic 4 (5 stories) = 14 stories total

---

## Epic Summary

**Epic 4 Goal:** Empower local managers with the tools to monitor their teams, communicate in real-time, and manage data quality via fraud alerts.

**FRs Covered:** FR11 (In-App Messaging), FR12 (Supervisor Dashboard), FR13 (Fraud Signal Engine)

### Delivery Metrics

| Metric | Prep Phase | Epic 4 | Combined |
|--------|-----------|--------|----------|
| Stories | 9 completed + 2 closed | 5/5 (100%) | 14 total |
| Tasks delivered | ~75 | ~62 | ~137 |
| Code review findings | 73 | 60 | 133 |
| Fix rate | 97% (2 deferred) | 95% (3 deferred) | 96.2% overall |
| Tests added | ~228 | ~349 | +577 (+36%) |

**Test Baseline:** 362 API + 1,240 web = 1,602
**After Prep:** ~482 API + ~1,348 web = ~1,830
**Final:** 667 API + 1,512 web = **2,179**

### Previous Retro Follow-Through: 100%

| # | Action Item (from Epic 3 Retro) | Status |
|---|--------------------------------|--------|
| prep-1 | Fix permanently completed form bug | Done |
| prep-2 | Dashboard submission counters | Done (expanded to full dashboard upgrade) |
| prep-3 | FR21 PRD alignment (NIN reject) | Done |
| prep-4 | RHF+Zod migration (ADR 4.3 debt) | Done |
| prep-5 | A3 ESLint enforcement | Done |
| prep-6 | Realtime messaging spike | Done |
| prep-7 | Fraud detection domain research | Done |
| prep-8 | Supervisor team assignment schema | Done |
| prep-9 | Fileblob base64-to-bytea | Closed (already resolved in Story 2.2) |
| prep-10 | Sub-path exports for types | Dropped (cosmetic, zero developer friction) |
| prep-11 | Offline queue user isolation | Done |

**Follow-through rate: 11/11 = 100%** (up from 93% in Epic 3)

---

## Key Capabilities Delivered

### Prep Phase
- **prep-1:** Fixed CRITICAL bug — completed forms showing permanent "Completed" badge, blocking re-submission. Client-side fix (delete draft from IndexedDB after queuing). 3 bonus fixes from UAT feedback (visible Submit button, navigate-back flow, phantom draft prevention).
- **prep-2:** Dashboard productivity upgrade — submission counters, daily activity charts (recharts), TotalSubmissionsCard, TodayProgressCard, SubmissionActivityChart. Supervisor dashboard wired live. Bento grid layout. Grew from 9 to 28 tasks.
- **prep-3:** PRD FR21 aligned from "link" to "reject" for NIN duplicates. Documentation-only, cross-artifact consistency verified.
- **prep-4:** Migrated FormFillerPage and ClerkDataEntryPage from controlled useState to React Hook Form + Zod per ADR 4.3. Dynamic schema builder utility.
- **prep-5:** ESLint enforcement of Team Agreement A3 (no CSS class selectors in tests). 22 files refactored. Automated regression test.
- **prep-6:** Realtime messaging spike. Evaluated Socket.io vs SSE vs ws. Selected Socket.io 4.8.3 (weighted score 4.80/5.00). Zero-rework handoff to Story 4.2.
- **prep-7:** Fraud detection domain research. 5 heuristic algorithms documented (GPS Clustering, Speed Run, Straight-lining, Duplicate, Off-Hours). Drizzle schemas, TypeScript types, Zod schemas, 27 seed records. Zero-rework handoff to Story 4.3.
- **prep-8:** Supervisor team assignment schema. `team_assignments` table with temporal soft-delete, partial unique index, Drizzle dual-FK relations. Assignment resolution service with LGA fallback.
- **prep-11:** CRITICAL security fix — offline queue user isolation. Fixed shared-device data leak vulnerability. Dexie v2 migration, sync lifecycle race condition prevention, logout warning dialog.

### Epic 4 Stories
- **4-1:** Supervisor team dashboard with roster table, GPS map (Leaflet + react-leaflet), daily/weekly performance metrics. Assignment-scoped via prep-8 service.
- **4-2:** Full messaging system — direct + broadcast, Socket.io realtime with polling fallback, message schema with thread isolation, rate limiting (10 msg/min, 3 broadcast/hr), inbox/thread UI, audit trail. 13 tasks, 48 subtasks.
- **4-3:** Complete Fraud Signal Engine — all 5 heuristics (GPS clustering with DBSCAN/Haversine, Speed Run with median/bootstrap, Straight-lining with PIR/entropy/LIS, Duplicate Response, Off-Hours). ConfigService with Redis caching, temporal threshold versioning, BullMQ worker integration, Super Admin threshold management UI. 118 fraud-specific tests.
- **4-4:** Flagged submission evidence panel — fraud detection list with filtering/pagination, accordion evidence panel (5 heuristic sections), GPS cluster map, review dialog with 6 resolution options, LGA scope enforcement.
- **4-5:** Bulk verification of mass events — cluster grouping (union-find algorithm from GPS JSONB), multi-select with floating action bar, transactional bulk review, success animation.

---

## Successes

### 1. Spike-First Pattern Delivered Zero Rework
Both prep-6 (Socket.io) and prep-7 (fraud heuristics) produced comprehensive handoff packages. Stories 4.2 and 4.3 — the two most complex stories in the epic — implemented on proven foundations with zero architectural rework. Team Agreement A5 validated.

### 2. 100% Previous Retro Follow-Through
All 11 action items from the Epic 3 retrospective were addressed — 9 completed, 1 already resolved, 1 dropped as unnecessary. This is up from 93% in Epic 3 and demonstrates improving team accountability.

### 3. CI/CD Pipeline as Automated Quality Gate
The CI pipeline (TypeScript strict mode, ESLint with A3 rules, full Vitest suite, `db:push:force` for non-interactive migrations) acts as an automated code reviewer. The iterative push-fix-push cycle catches type errors, lint violations, and regressions before human review. Identified as institutional knowledge worth extracting as a reusable template for future projects.

### 4. Adversarial Code Review Process Maturing
133 findings across 14 stories with 96.2% fix rate. The process is catching real issues — security filter gaps, type safety problems, dead code, missing test scenarios — and the team resolves nearly all of them within the same review cycle.

### 5. Critical Security Vulnerability Fixed (prep-11)
Offline queue user isolation addressed a CRITICAL shared-device data leak: switching accounts could expose another user's survey data or attribute submissions to the wrong person. Dexie v2 migration with legacy sentinel, sync lifecycle race condition prevention, and logout warning dialog.

### 6. Test Suite Growth
577 new tests (+36% growth) from 1,602 to 2,179. Zero regressions across all 14 stories. The test suite provides strong automated coverage for the growing codebase.

---

## Challenges

### 1. Scope Creep in Story Implementation
- **prep-2** started as 9 tasks ("add submission counters") and grew to 28 tasks (full dashboard upgrade with recharts, bento grid, supervisor APIs). 3x the original scope.
- **Story 4.2** was 13 tasks / 48 subtasks — described as "three stories in a trenchcoat." Required two full code review rounds.
- **Story 4.3** hit the A4 limit at exactly 15 tasks.

### 2. Recurring Review Finding: WHERE Clause Test Gaps
The #1 recurring code review issue: tests that pass green but don't verify security-critical SQL WHERE clause arguments. Found in 4 stories (prep-2, prep-7, prep-8, 4.2). Test mocks return static data regardless of filter inputs, so removing a user-isolation filter wouldn't cause test failure.

### 3. File List Inaccuracy in Story Artifacts
6 of 14 stories had File Lists that didn't match actual git changes. Story artifacts said one thing, git diff showed another. Reduces traceability and makes story artifacts less trustworthy as documentation.

### 4. Interface Changes Causing Cascading Test Breakage
- prep-11: Changing `AuthContextValue` interface broke 10+ test files (4 CRITICAL build errors)
- Story 4.2: Extensive mock updates required across messaging test files
- Pattern: adding fields to shared interfaces forces updating every mock that spreads the interface

### 5. Backend-Heavy Features Have Limited UAT Coverage
The quality safety net has three layers: automated tests, adversarial code review, and human UAT. Epic 4's backend-heavy features (fraud engine algorithms, messaging infrastructure, team assignment service) have strong coverage on layers 1 and 2, but limited coverage on layer 3. Issues in these features — particularly fraud threshold calibration — may only surface during real field data collection. The team acknowledges this gap and trusts the process: green tests + adversarial review + configurable thresholds for runtime tuning.

---

## Bugs Discovered During Retrospective

### Bug 1: Supervisor Cannot Initiate Direct Messages to Individual Team Members
**Discovered by:** Awwal (UAT during retrospective)
**Severity:** HIGH
**Description:** The Supervisor can send broadcast messages to the whole team (confirmed working), but cannot initiate a 1:1 direct message to a specific team member. The Messages page shows existing threads in the inbox, but there's no "New Conversation" flow to select a team member from the roster and start a direct chat. The backend fully supports direct messaging (recipientId, thread isolation) — this is a frontend UX gap.
**Action:** Add to Epic 5 prep tasks as prep-1.

---

## Key Insights

1. **The spike-first pattern (A5) is the team's most valuable process innovation.** Both spikes this epic delivered zero-rework implementations. Continue this for any new domain in Epic 5.

2. **CI/CD pipeline is institutional knowledge.** The specific configuration (turborepo routing, ESLint A3 rules, `db:push:force`, TypeScript strict, Vitest split config) is a competitive advantage worth packaging as a reusable template.

3. **UAT coverage gaps correlate with backend complexity.** Frontend-heavy features get natural UAT coverage through visual testing. Backend-heavy features (algorithms, queue workers, scoring engines) rely entirely on automated tests and code review. The team accepts this trade-off for Epic 4 and trusts the configurable threshold design for runtime tuning.

4. **Story sizing remains a challenge.** Despite the A4 15-task limit, stories still grow significantly during implementation (prep-2: 3x growth). Consider setting a softer target of 12 tasks with the 15-task limit as a hard ceiling that triggers mandatory splitting.

5. **Test mock patterns need strengthening.** WHERE clause verification gaps and cascading interface changes both point to test mock architecture as an area for improvement. Adding verification of SQL filter arguments to the testing standard would catch security issues earlier.

---

## Epic 5 Preview: Back-Office Audit & Policy Reporting

**Epic 5 Goal:** Provide high-level stakeholders and state auditors with the tools to verify registry integrity and extract policy-driving insights.

### Stories (Updated)

| Story | Title | Description |
|-------|-------|-------------|
| 5-1 | High-Level Policy Dashboard | Government Official read-only state-wide labor stats, skills charts, LGA heatmaps |
| 5-2 | Verification Assessor Audit Queue | State-wide queue of supervisor-verified/high-fraud submissions for secondary QC |
| 5-3 | Individual Record PII View | Authorized deep-dive into respondent PII with mandatory audit logging |
| 5-4 | PII-Rich CSV/PDF Exports | Filtered dataset exports with PII for offline government analysis |
| 5-5 | **Respondent Data Registry Table (NEW)** | Server-paginated, filterable table of all respondent records for authorized roles |

### Story 5.5 Definition (from Retrospective)

**Discovered by:** Awwal (retrospective discussion)
**Rationale:** No existing Epic 5 story provides a browsable table of all respondent data. Stories 5.1-5.4 cover dashboards, audit queues, single-record views, and exports — but not the fundamental "browse and search all records" use case.

**Access Control:**

| Role | Scope | PII Visible | Audit Logged |
|------|-------|:-----------:|:------------:|
| Super Admin | All LGAs | Yes | Yes |
| Verification Assessor | All LGAs | Yes | Yes (every row view) |
| Government Official | All LGAs | Yes | Yes (every row view) |
| Supervisor | Own LGA only | No (operational data only) | Yes |

**Filter Controls:**
- LGA (dropdown, pre-filtered for Supervisors)
- Gender (male / female / other)
- Collection channel (Public Self-Registration, Enumerator Field Collection, Data Entry Clerk)
- Date range (from/to date picker)
- Verification status (pending, verified, rejected, quarantined)
- Fraud severity (clean, low, medium, high, critical)
- Form/questionnaire type
- Enumerator (who collected it)
- Free text search (respondent name or NIN — PII roles only)

**Column Visibility per Role:**

| Column | Super Admin | Assessor | Official | Supervisor |
|--------|:-----------:|:--------:|:--------:|:----------:|
| Respondent Name | Yes | Yes | Yes | No |
| NIN | Yes | Yes | Yes | No |
| Phone | Yes | Yes | Yes | No |
| Gender | Yes | Yes | Yes | Yes |
| LGA | Yes | Yes | Yes | Yes (own) |
| Collection Channel | Yes | Yes | Yes | Yes |
| Enumerator | Yes | Yes | Yes | Yes (own team) |
| Submission Date | Yes | Yes | Yes | Yes |
| Fraud Score | Yes | Yes | Read-only | Yes |
| Verification Status | Yes | Yes | Read-only | Yes |
| Form Responses | Yes | Yes | Yes | No |

**Technical Requirements:**
- Server-side pagination (cursor-based for performance at 1M records)
- Server-side filtering and sorting (query params to API)
- TanStack Table in server-side mode
- Designed to scale from pilot (thousands) to target (1M records)
- Export integration: Story 5.4 exports should respect active filters from this table

**Dependencies on Epic 4:**
- `fraud_detections` table (severity scores, resolution status)
- `team_assignments` table (supervisor LGA scoping)
- Respondent data from submissions pipeline

---

## Action Items

### Process Improvements

| # | Action | Owner | Success Criteria |
|---|--------|-------|-----------------|
| 1 | Story sizing discipline — target 12 tasks, hard limit 15 | Bob (SM) | No Epic 5 story exceeds 12 tasks |
| 2 | WHERE clause test verification standard | Charlie (Dev) | Added to project-context.md; code review checks for filter argument assertions |
| 3 | File List accuracy enforcement | Dev agents | File List matches git diff at story completion; code review verifies |
| 4 | Extract CI/CD pipeline as reusable template | Awwal + Charlie | Turborepo config, ESLint A3 rules, Vitest split config, db:push:force, TypeScript strict, test conventions packaged as portable template |
| 5 | Update project-context.md with Epic 4 patterns | Dev agent | Fraud engine architecture, messaging patterns, team assignment model, WHERE clause testing rule added |

### Deferred Review Items (All LOW — no action needed)

| # | Story | Item |
|---|-------|------|
| 1 | prep-6 | Duplicate test coverage between auth.test.ts and security.boundary.test.ts |
| 2 | prep-8 | epics.md modified in git but not documented in File List |
| 3 | 4-2 | Realtime handler unit tests (covered by integration tests) |
| 4 | 4-2 | Accepted code duplication in messaging hooks |
| 5 | 4-4 | JSONB detail type migration to @oslsr/types |

---

## Epic 5 Preparation Tasks

| # | Task | Priority | Description |
|---|------|----------|-------------|
| prep-1 | Fix supervisor direct messaging UX | HIGH | Add "New Conversation" flow with team roster selection to SupervisorMessagesPage. Backend supports direct messaging — frontend UX gap only. |
| prep-2 | Lightweight audit logging for PII access | HIGH | Required by Stories 5.3, 5.4, 5.5. Decide: build lightweight audit logger now, or pull Story 6.1 (Immutable Audit Logs) forward partially. |
| prep-3 | Export infrastructure spike | HIGH | CSV/PDF generation with security controls (logged, role-authorized). Evaluate PDFKit (already installed) + CSV library. |
| prep-4 | Define Story 5.5 in epics.md | HIGH | Add Respondent Data Registry Table story with full ACs from this retrospective. |
| prep-5 | Cross-LGA query performance validation | MEDIUM | Run state-wide aggregation queries at scale. Ensure Official/Assessor views don't degrade. |
| prep-6 | Assessor workflow state machine design | MEDIUM | Document submission lifecycle: submission -> fraud scoring -> supervisor review -> assessor audit -> final status. |
| prep-7 | E2E test expansion | NICE-TO-HAVE | Playwright tests for fraud threshold UI, messaging inbox, supervisor team dashboard. |

---

## Commitments and Next Steps

1. **Execute prep tasks** (7 items, 3 HIGH priority)
2. **Complete process improvement action items** (5 items)
3. **Add Story 5.5 to epics.md** with full definition from this retrospective
4. **Begin Epic 5** when prep tasks complete
5. **Review action items in next standup** — ensure ownership is clear

---

## Team Performance

Epic 4 delivered 14 stories with 137 tasks, 577 new tests, and zero regressions. Code review caught 133 issues with a 96.2% fix rate. The team achieved 100% follow-through on previous retro action items — up from 93% in Epic 3. The spike-first pattern proved its value with zero-rework implementations for the two most complex stories. The CI/CD pipeline served as an automated quality gate throughout.

The team is well-positioned for Epic 5 success, with strong foundations in fraud detection, messaging infrastructure, and dashboard patterns. The main preparation needs are: fixing the supervisor direct messaging UX gap, establishing PII audit logging, building export infrastructure, and defining the new Story 5.5 (Respondent Data Registry Table).

---

*Generated: 2026-02-20 | Retrospective facilitated by Bob (Scrum Master)*
