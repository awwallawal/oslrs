# Story 2.5.5: Enumerator Dashboard Shell

Status: done

## Story

As an Enumerator,
I want my mobile-optimized dashboard with survey access and sync status,
So that I can start surveys, resume drafts, and know my work is being saved.

## Acceptance Criteria

### AC1: Mobile-Optimized Dashboard Home
**Given** an Enumerator logging in on mobile, **when** they reach `/dashboard/enumerator`, **then** they see a touch-optimized layout with:
- **"Start Survey" primary CTA** - large Oyo Red (#9C1E23) button, minimum 48px height, full width on mobile (`w-full`), auto width on desktop
- **"Resume Draft" button** (placeholder) - shows "No drafts yet" when empty, prominently displayed below Start Survey
- **"Daily Progress" card** - shows placeholder "0 / 25 surveys today" with progress visualization
- **Sync Status indicator** - shows sync state (Synced/Queued/Uploading/Failed) in header area

### AC2: Survey List
**Given** the published native form questionnaires, **when** Enumerator views available surveys, **then** they see a list of active questionnaires with "Start Survey" buttons.

**Given** no questionnaires are published, **when** Enumerator views the survey list, **then** they see an empty state: "No surveys assigned yet. Contact your supervisor."

### AC3: Start Survey Placeholder
**Given** the "Start Survey" button, **when** clicked, **then** it shows a "Coming in Epic 3" modal explaining that the native form renderer will be available in Epic 3.

### AC4: Sidebar Navigation (Mobile: Bottom Nav)
**Given** the sidebar navigation (mobile: bottom nav), **then** Enumerator sees exactly 4 items matching `sidebarConfig.ts`:
- Home (Home icon) - `/dashboard/enumerator`
- Surveys (FileText icon) - `/dashboard/enumerator/survey`
- Drafts (Save icon) - `/dashboard/enumerator/drafts`
- Sync Status (RefreshCw icon) - `/dashboard/enumerator/sync`

> **Note:** sidebarConfig.ts already has 4 items for enumerator. The current config uses "Start Survey", "Drafts", "Sync Status" labels. Per the epics, update the `sidebarConfig.ts` label from "Start Survey" to "Surveys" to match this AC. Keep the icon and href unchanged. Do NOT change the other labels — "Sync Status" is the correct label per the UX spec's Sync Status Badge component spec.

### AC5: PWA Service Worker Registration
**Given** the PWA offline capability requirement, **then** the dashboard shell registers a service worker with a no-op fetch handler (actual caching logic in Epic 3 Story 3-2).

> **Note:** The no-op `sw.js` registered at root scope (`/`) is intentionally unscoped for this shell story. Epic 3 Story 3-2 will define the proper caching strategy and may re-scope the service worker as needed.

### AC6: Route Guards (RBAC)
**Given** an Enumerator attempts to access `/dashboard/super-admin/*` or `/dashboard/supervisor`, **then** they receive 403 Forbidden.

> **Already implemented** in Story 2.5-1 via `ProtectedRoute allowedRoles={['enumerator']}` wrapping enumerator routes. Verified by RBAC tests in `rbac-routes.test.tsx`. No new RBAC work needed — just verify existing tests still pass.

## Tasks / Subtasks

- [x] Task 1: Update sidebarConfig.ts (AC: #4)
  - [x] 1.1 Change enumerator "Start Survey" label to "Surveys" in sidebarConfig.ts
  - [x] 1.2 Update sidebarConfig.test.ts to verify the label change (if label is asserted)
- [x] Task 2: Build EnumeratorHome dashboard page (AC: #1, #3)
  - [x] 2.1 Replace placeholder `EnumeratorHome.tsx` with real mobile-optimized dashboard layout
  - [x] 2.2 Create "Start Survey" primary CTA button (Oyo Red, 48px height, prominent)
  - [x] 2.3 Create "Resume Draft" section (placeholder: "No drafts yet" empty state with Save icon)
  - [x] 2.4 Create "Daily Progress" card (placeholder: "0 / 25 surveys today" with progress bar at 0%)
  - [x] 2.5 Add Sync Status indicator in header area (placeholder: show "Synced" green badge)
  - [x] 2.6 Add "Coming in Epic 3" AlertDialog modal triggered by Start Survey CTA click
  - [x] 2.7 Use `SkeletonCard` for loading state — hardcode `const isLoading = false;` (same pattern as SupervisorHome). Skeleton branch must exist in JSX so tests can verify it.
- [x] Task 3: Build Surveys list page placeholder (AC: #2) — page component only, route in Task 6
  - [x] 3.1 Create `EnumeratorSurveysPage.tsx` in `apps/web/src/features/dashboard/pages/`
  - [x] 3.2 Show empty state: "No surveys assigned yet. Contact your supervisor." with FileText icon
- [x] Task 4: Build Drafts placeholder page (AC: #4 sidebar link target) — page component only, route in Task 6
  - [x] 4.1 Create `EnumeratorDraftsPage.tsx` in `apps/web/src/features/dashboard/pages/`
  - [x] 4.2 Show empty state: "No drafts saved" with Save icon
- [x] Task 5: Build Sync Status placeholder page (AC: #4 sidebar link target) — page component only, route in Task 6
  - [x] 5.1 Create `EnumeratorSyncPage.tsx` in `apps/web/src/features/dashboard/pages/`
  - [x] 5.2 Show sync info: "All data synced" green badge, "Last synced: just now" placeholder text
- [x] Task 6: Register new routes in App.tsx (AC: #2, #4)
  - [x] 6.1 Lazy-load `EnumeratorSurveysPage`, `EnumeratorDraftsPage`, `EnumeratorSyncPage`
  - [x] 6.2 Add child routes under the existing enumerator `<Route path="enumerator">` block in App.tsx:
    - `survey` → EnumeratorSurveysPage
    - `drafts` → EnumeratorDraftsPage
    - `sync` → EnumeratorSyncPage
  - [x] 6.3 Keep wildcard `<Route path="*">` as final catch-all after all sub-routes
- [x] Task 7: Register Service Worker (AC: #5)
  - [x] 7.1 Create `apps/web/public/sw.js` with no-op fetch handler (empty service worker shell)
  - [x] 7.2 Add service worker registration in EnumeratorHome.tsx using `navigator.serviceWorker?.register('/sw.js')` inside a `useEffect` — register only once, only for enumerator role
  - [x] 7.3 Add error handling for browsers that don't support service workers
- [x] Task 8: Write tests (AC: #1, #2, #3, #4, #5, #6)
  - [x] 8.1 Create `EnumeratorHome.test.tsx` - renders Start Survey CTA, Resume Draft section, Daily Progress card, Sync Status badge, skeleton branch, "Coming in Epic 3" modal on CTA click
  - [x] 8.2 Create `EnumeratorSurveysPage.test.tsx` - renders empty state message
  - [x] 8.3 Create `EnumeratorDraftsPage.test.tsx` - renders empty state message
  - [x] 8.4 Create `EnumeratorSyncPage.test.tsx` - renders sync status display
  - [x] 8.5 Verify existing RBAC tests still pass (run full test suite)

### Review Follow-ups (AI)
- [x] [AI-Review][HIGH] H1: Move Sync Status badge to header area per AC1 — was placed below cards [EnumeratorHome.tsx:118-128]
- [x] [AI-Review][HIGH] H2: Move Sync Status badge inside isLoading guard — was visible during skeleton loading [EnumeratorHome.tsx:118-128]
- [x] [AI-Review][MEDIUM] M1: Add skeleton loading branch test — isLoading prop for testability [EnumeratorHome.test.tsx:89-97]
- [x] [AI-Review][MEDIUM] M2: Add role="status" and aria-live="polite" to Sync Status indicator [EnumeratorHome.tsx:119]
- [x] [AI-Review][MEDIUM] M3: AlertDialogOverlay ref forwarding warning — fixed with React.forwardRef in alert-dialog.tsx:24-38
- [x] [AI-Review][LOW] L1: Add AlertDialogCancel to "Coming in Epic 3" modal for pattern consistency [EnumeratorHome.tsx:140-145]
- [x] [AI-Review][LOW] L2: Swap FileText icon on Daily Progress card to TrendingUp (progress-semantic) [EnumeratorHome.tsx:105]

## Dev Notes

### Architecture Compliance

- **Layout:** Uses existing `DashboardLayout` from Story 2.5-1 — do NOT create a new layout
- **Route protection:** Already handled by `ProtectedRoute allowedRoles={['enumerator']}` in App.tsx
- **Loading states:** MUST use `SkeletonCard` from `apps/web/src/components/skeletons/` — NEVER spinners (ADR-016, project-context.md anti-pattern #5)
- **Icons:** Use lucide-react icons: `Home`, `FileText`, `Save`, `RefreshCw`, `ChevronRight`, `CheckCircle`, `Clock`
- **Card components:** Use `Card`, `CardHeader`, `CardTitle`, `CardContent` from `apps/web/src/components/ui/card.tsx`
- **Styling:** Tailwind CSS v4 classes. Follow the SupervisorHome.tsx / SuperAdminHome.tsx card patterns
- **Mobile-first:** This is the most mobile-critical dashboard. Use `flex flex-col gap-4` stacking on mobile, `md:grid md:grid-cols-2 md:gap-6` on tablet+
- **Touch targets:** All interactive elements MUST be minimum 48px height (exceeds WCAG 2.1 AA 44px)
- **AlertDialog:** Use existing AlertDialog component from `apps/web/src/components/ui/alert-dialog.tsx` for the "Coming in Epic 3" modal

### Established Patterns to Follow

**Mobile-first dashboard layout** (from UX spec):
```tsx
<div className="p-6">
  <div className="mb-6">
    <h1 className="text-2xl font-brand font-semibold text-neutral-900">
      Enumerator Dashboard
    </h1>
    <p className="text-neutral-600 mt-1">
      Survey collection and progress tracking
    </p>
  </div>

  {/* Mobile: stacked, Tablet+: grid */}
  <div className="flex flex-col gap-4 md:grid md:grid-cols-2 md:gap-6">
    {/* cards */}
  </div>
</div>
```

**Primary CTA button pattern** (Oyo Red, mobile-optimized):
```tsx
<button
  onClick={() => setShowEpic3Modal(true)}
  className="w-full md:w-auto min-h-[48px] px-8 py-3 bg-primary-600 hover:bg-primary-700 text-white font-semibold rounded-lg text-lg transition-colors"
>
  Start Survey
</button>
```

**Dashboard card pattern** (from SuperAdminHome.tsx):
```tsx
<Card className="cursor-pointer hover:shadow-md transition-shadow" onClick={() => navigate('/...')}>
  <CardHeader className="pb-2">
    <div className="flex items-center justify-between">
      <div className="flex items-center gap-2">
        <div className="p-2 bg-{color}-100 rounded-lg">
          <Icon className="w-5 h-5 text-{color}-600" />
        </div>
        <CardTitle className="text-base">Title</CardTitle>
      </div>
      <ChevronRight className="w-5 h-5 text-neutral-400" />
    </div>
  </CardHeader>
  <CardContent>...</CardContent>
</Card>
```

**Skeleton loading pattern** (from SupervisorHome.tsx):
```tsx
const isLoading = false; // Hardcoded — swap for real hook in Epic 3/4

{isLoading ? (
  <div className="flex flex-col gap-4 md:grid md:grid-cols-2 md:gap-6">
    <SkeletonCard />
    <SkeletonCard />
    <SkeletonCard />
  </div>
) : (
  <div className="flex flex-col gap-4 md:grid md:grid-cols-2 md:gap-6">
    {/* actual cards */}
  </div>
)}
```

**Lazy route registration pattern** (from App.tsx):
```tsx
const EnumeratorSurveysPage = lazy(() => import('./features/dashboard/pages/EnumeratorSurveysPage'));
// ... inside enumerator Route block:
<Route path="survey" element={<Suspense fallback={<DashboardLoadingFallback />}><EnumeratorSurveysPage /></Suspense>} />
```

**Empty state pattern** for placeholder pages:
```tsx
<div className="p-6">
  <div className="mb-6">
    <h1 className="text-2xl font-brand font-semibold text-neutral-900">Page Title</h1>
    <p className="text-neutral-600 mt-1">Description</p>
  </div>
  <Card>
    <CardContent className="flex flex-col items-center justify-center py-16 text-center">
      <Icon className="w-12 h-12 text-neutral-300 mb-4" />
      <p className="text-neutral-500 font-medium">Empty state message</p>
      <p className="text-sm text-neutral-400 mt-1">Helpful sub-text</p>
    </CardContent>
  </Card>
</div>
```

**Service worker registration pattern:**
```tsx
useEffect(() => {
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js').catch(() => {
      // Service worker registration failed — non-blocking
    });
  }
}, []);
```

**No-op service worker** (`apps/web/public/sw.js`):
```js
// OSLSR Service Worker Shell
// Actual caching and offline logic will be implemented in Epic 3 Story 3-2
self.addEventListener('fetch', () => {
  // No-op: let all requests pass through to network
});
```

### Color Scheme for Enumerator Cards

Follow UX spec + established icon-background color pattern:
- **Start Survey CTA:** `bg-primary-600` / `text-white` (Oyo Red — primary action)
- **Resume Draft:** `bg-amber-100` / `text-amber-600` (Save icon — draft/pending color)
- **Daily Progress:** `bg-emerald-100` / `text-emerald-600` (progress/success color)
- **Sync Status badge:** Green `bg-emerald-100 text-emerald-600` for "Synced", amber for "Queued", red for "Failed"

### Project Structure Notes

**New files to create:**
```
apps/web/src/features/dashboard/pages/
  EnumeratorSurveysPage.tsx          # Survey list placeholder
  EnumeratorDraftsPage.tsx           # Drafts placeholder
  EnumeratorSyncPage.tsx             # Sync status placeholder
  __tests__/EnumeratorHome.test.tsx
  __tests__/EnumeratorSurveysPage.test.tsx
  __tests__/EnumeratorDraftsPage.test.tsx
  __tests__/EnumeratorSyncPage.test.tsx

apps/web/public/
  sw.js                              # No-op service worker shell
```

**Files to modify:**
```
apps/web/src/features/dashboard/pages/EnumeratorHome.tsx    # Replace placeholder with real dashboard
apps/web/src/features/dashboard/config/sidebarConfig.ts     # Change "Start Survey" label to "Surveys"
apps/web/src/App.tsx                                         # Add 3 new enumerator child routes
apps/web/src/features/dashboard/__tests__/sidebarConfig.test.ts  # Update if label is asserted
```

### sidebarConfig.ts Change Detail

Current enumerator config (4 items — count stays the same):
```ts
enumerator: [
  { label: 'Home', href: '/dashboard/enumerator', icon: Home },
  { label: 'Start Survey', href: '/dashboard/enumerator/survey', icon: FileText },  // RENAME label
  { label: 'Drafts', href: '/dashboard/enumerator/drafts', icon: Save },
  { label: 'Sync Status', href: '/dashboard/enumerator/sync', icon: RefreshCw },
],
```

Target (same 4 items, label change only):
```ts
enumerator: [
  { label: 'Home', href: '/dashboard/enumerator', icon: Home },
  { label: 'Surveys', href: '/dashboard/enumerator/survey', icon: FileText },       // RENAMED
  { label: 'Drafts', href: '/dashboard/enumerator/drafts', icon: Save },
  { label: 'Sync Status', href: '/dashboard/enumerator/sync', icon: RefreshCw },
],
```

### Test Strategy

- **Unit tests:** Each new page component renders correctly with expected elements
- **EnumeratorHome tests:** Renders Start Survey CTA, Resume Draft section, Daily Progress card, Sync Status badge, skeleton branch when isLoading=true, "Coming in Epic 3" modal appears on CTA click
- **Placeholder page tests:** Each renders correct heading and empty state message
- **Regression:** Run full test suite to verify RBAC tests and existing sidebarConfig tests still pass
- **Test location:** Page tests in `apps/web/src/features/dashboard/pages/__tests__/` (matches SupervisorHome.test.tsx convention); config tests in `apps/web/src/features/dashboard/__tests__/`
- **Mocking pattern:** Use `vi.hoisted()` + `vi.mock()` for react-router-dom `useNavigate`
- **Service worker test:** Mock `navigator.serviceWorker` in EnumeratorHome test to verify registration call

### References

- [Source: epics.md, Story 2.5-5, lines 962-977]
- [Source: architecture.md, ADR-016 Layout Architecture]
- [Source: ux-design-specification.md, Enumerator Journey 1: Offline Survey Collection]
- [Source: ux-design-specification.md, Bottom Tab Navigation pattern]
- [Source: ux-design-specification.md, Sync Status Badge component spec]
- [Source: project-context.md, Anti-pattern #5 (no spinners), Rule #4 (skeleton screens)]
- [Source: 2.5-1-dashboard-layout-architecture-role-routing.md, DashboardLayout + bottom nav]
- [Source: 2.5-4-supervisor-dashboard-shell.md, Card pattern reference + test patterns]
- [Source: SuperAdminHome.tsx, Card pattern reference]
- [Source: sidebarConfig.ts, Current enumerator nav items]

### Previous Story Intelligence

**From Story 2.5-1 (Dashboard Layout):**
- DashboardLayout, DashboardSidebar, DashboardHeader, DashboardBottomNav all established
- `sidebarConfig.ts` drives all nav items — single source of truth for sidebar
- Route guard pattern: `ProtectedRoute allowedRoles={['enumerator']}` wrapping `<Outlet />`
- Mobile bottom nav already renders for touch-primary roles (enumerator included)
- Placeholder pages follow consistent pattern: page title + subtitle + skeleton cards

**From Story 2.5-4 (Supervisor Dashboard Shell):**
- Card-based dashboard home with 3 cards + header area (Team Overview, Alerts, Collection)
- SupervisorHome.tsx is latest reference for dashboard card layout
- Skeleton loading branch with hardcoded `isLoading = false` — same pattern needed here
- Empty state pattern for placeholder pages (icon + message + sub-text)
- 16 new tests added; total web test count after 2.5-4: 796
- Code review found: `CardTitle` renders as `div[data-slot="card-title"]` not `h3` — use `querySelectorAll('[data-slot="card-title"]')` in tests

**From Story 2.5-2 (Super Admin Questionnaires):**
- `SuperAdminHome.tsx` is the original reference for dashboard cards
- Uses `useNavigate()` for card click navigation
- `SkeletonCard` for loading states
- Card grid: `grid gap-6 md:grid-cols-2 lg:grid-cols-3`

**From Story 2.5-3 (Staff Management):**
- AlertDialog pattern for confirmation modals — reuse for "Coming in Epic 3" modal
- Code review found 8 issues across 2 review cycles — be thorough

**Git Recent Commits (relevant):**
- `3ab6abf` fix: resolve 7 code review issues for Story 2.5-3 staff management
- `c0e3996` fix: resolve delete toast error and add status management
- `09dea56` feat: Native Form Builder UI with code review fixes (Story 2.10)

### What NOT To Do

- Do NOT create any API endpoints or backend services — this is a frontend-only shell story
- Do NOT fetch real survey/form data — no enumerator-specific API exists yet (Epic 3)
- Do NOT implement actual form rendering — that's Epic 3 Story 3-1
- Do NOT implement actual IndexedDB draft storage — that's Epic 3 Story 3-2/3-3
- Do NOT implement actual sync/upload logic — that's Epic 3 Story 3-3
- Do NOT create a new layout component — use existing DashboardLayout
- Do NOT use spinners for loading states — use SkeletonCard only
- Do NOT add real service worker caching logic — only register a no-op shell (Epic 3 Story 3-2)
- Do NOT add the enumerator role to any other role's routes

## Dev Agent Record

### Agent Model Used

Claude Opus 4.6

### Debug Log References

- Service worker mocking in jsdom required `vi.stubGlobal('navigator', ...)` — `Object.defineProperty` on `window.navigator` or `Navigator.prototype` does not work in jsdom
- `CheckCircle` from lucide-react renders as CSS class `lucide-circle-check-big` (not `lucide-circle-check`)
- DashboardLayout test had hardcoded "Start Survey" label for enumerator nav — updated to "Surveys" to match sidebarConfig change

### Completion Notes List

- **Task 1:** Renamed enumerator sidebar label from "Start Survey" to "Surveys" in `sidebarConfig.ts`. Updated comment. Existing sidebarConfig tests pass without changes (no label-specific assertions). Updated DashboardLayout test that asserted the old label.
- **Task 2:** Replaced placeholder EnumeratorHome with full mobile-optimized dashboard: Start Survey CTA (Oyo Red, 48px min height, full-width mobile), Resume Draft card (empty state), Daily Progress card (0/25 with progress bar), Sync Status badge (green "Synced"), Coming in Epic 3 AlertDialog modal, skeleton loading branch.
- **Task 3-5:** Created three placeholder pages (EnumeratorSurveysPage, EnumeratorDraftsPage, EnumeratorSyncPage) following established empty-state pattern with icons and descriptive text.
- **Task 6:** Added lazy-loaded imports and child routes (`survey`, `drafts`, `sync`) under the enumerator route block in App.tsx. Wildcard catch-all kept as final route.
- **Task 7:** Created no-op `sw.js` in public directory. Service worker registration in EnumeratorHome via `useEffect` with optional chaining (`navigator.serviceWorker?.register`) and try-catch for graceful fallback.
- **Task 8:** Created 4 test files with 21 new tests total (12 EnumeratorHome, 3 Surveys, 3 Drafts, 3 Sync). All 821 web tests pass (21 new + 800 existing). Zero regressions.

### Change Log

- 2026-02-08: Story 2.5-5 implemented — Enumerator dashboard shell with mobile-first layout, Start Survey CTA, placeholder cards, service worker shell, 3 placeholder sub-pages, 21 new tests
- 2026-02-08: Code review fixes (round 1) — Moved Sync Status badge to header area (H1), wrapped in isLoading guard (H2), added role="status"+aria-live (M2), added isLoading prop for testability + skeleton rendering test (M1).
- 2026-02-08: Code review fixes (round 2) — Fixed AlertDialogOverlay forwardRef warning (M3), added AlertDialogCancel for pattern consistency (L1), swapped FileText→TrendingUp for Daily Progress icon (L2). All 7 review items resolved. 823 web tests pass.

### File List

**New files:**
- `apps/web/src/features/dashboard/pages/EnumeratorSurveysPage.tsx`
- `apps/web/src/features/dashboard/pages/EnumeratorDraftsPage.tsx`
- `apps/web/src/features/dashboard/pages/EnumeratorSyncPage.tsx`
- `apps/web/src/features/dashboard/pages/__tests__/EnumeratorHome.test.tsx`
- `apps/web/src/features/dashboard/pages/__tests__/EnumeratorSurveysPage.test.tsx`
- `apps/web/src/features/dashboard/pages/__tests__/EnumeratorDraftsPage.test.tsx`
- `apps/web/src/features/dashboard/pages/__tests__/EnumeratorSyncPage.test.tsx`
- `apps/web/public/sw.js`

**Modified files:**
- `apps/web/src/features/dashboard/pages/EnumeratorHome.tsx` (replaced placeholder with full dashboard)
- `apps/web/src/features/dashboard/config/sidebarConfig.ts` (label: "Start Survey" → "Surveys")
- `apps/web/src/App.tsx` (added 3 lazy imports + 3 child routes for enumerator)
- `apps/web/src/layouts/__tests__/DashboardLayout.test.tsx` (updated "Start Survey" → "Surveys" assertion)
- `_bmad-output/implementation-artifacts/sprint-status.yaml` (status: ready-for-dev → in-progress → review)
